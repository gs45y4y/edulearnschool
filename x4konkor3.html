<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>EdulearnOS | Activities</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&family=Fira+Code:wght@400;700&display=swap"
		rel="stylesheet" />
	<style>
		/* --- CORE VARIABLES --- */
		:root {
			--accent-color: #0078d4;
			--glass-border: rgba(0, 120, 212, 0.3);
			--glass-bg: rgba(255, 255, 255, 0.08);
			--dock-bg: rgba(10, 20, 30, 0.6);
			--win-bg: rgba(5, 8, 12, 0.96);
			--text: #ffffff;
			--term-bg: #1a1b26;
			--term-green: #9ece6a;
			--term-blue: #7aa2f7;
			--term-red: #f7768e;
			--term-yellow: #e0af68;
		}

		/* --- GLOBAL RESET --- */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			user-select: none;
			cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M16 8 L16 24 M8 16 L24 16' stroke='white' stroke-width='3'/></svg>") 16 16, auto !important;
		}

		iframe {
			cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path d='M16 8 L16 24 M8 16 L24 16' stroke='white' stroke-width='3'/></svg>") 16 16, auto !important;
		}

		body {
			background: #050505 url('https://blogs.windows.com/wp-content/uploads/sites/2/2021/10/Windows-11-Bloom-Screensaver-Dark-scaled.jpg') no-repeat center center fixed;
			background-size: cover;
			color: var(--text);
			font-family: 'Inter', sans-serif;
			height: 100vh;
			overflow: hidden;
			transition: background-image 0.5s ease-in-out;


		}

		/* --- BRANDING --- */
		#os-brand {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 10vw;
			font-weight: 900;
			color: rgba(255, 255, 255, 0.95);
			text-shadow: 0 0 20px rgba(0, 0, 0, 0.5), 0 0 40px var(--accent-color);
			z-index: 0;
			pointer-events: none;
			text-transform: uppercase;
			letter-spacing: -0.02em;
			white-space: nowrap;
			transition: text-shadow 0.5s ease;
		}

		#lifeblood-canvas {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 1;
			pointer-events: none;
		}

		#snap-preview {
			position: fixed;
			background: rgba(125, 212, 255, 0.15);
			border: 2px dashed var(--accent-color);
			border-radius: 20px;
			z-index: 5;
			display: none;
			pointer-events: none;
			transition: all 0.2s cubic-bezier(0.2, 0, 0.2, 1);
		}

		#desktop {
			position: relative;
			z-index: 2;
			width: 100%;
			height: 100vh;
			padding: 20px;
		}

		/* --- ICONS --- */
		.icon {
			position: absolute;
			display: flex;
			flex-direction: column;
			align-items: center;
			text-align: center;
			cursor: grab;
			width: 90px;
			transition: transform 0.2s, top 0.2s ease-out, left 0.2s ease-out;
		}

		/* When dragging, disable transition for smooth movement */
		.icon.is-dragging {
			transition: none;
			cursor: grabbing;
			z-index: 9999;
		}

		.icon:hover {
			transform: scale(1.1);
			z-index: 100;
		}

		.icon-visual {
			width: 60px;
			height: 60px;
			margin-bottom: 8px;
			background: var(--glass-bg);
			border: 1px solid var(--glass-border);
			border-radius: 16px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 26px;
			backdrop-filter: blur(15px);
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
			color: var(--accent-color);
			transition: color 0.3s, border-color 0.3s;
		}

		.icon span {
			font-size: 11px;
			text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
			background: rgba(0, 0, 0, 0.3);
			padding: 2px 6px;
			border-radius: 8px;
		}

		/* --- WINDOW SYSTEM --- */
		.window {
			position: absolute;
			width: 900px;
			height: calc(100vh - 140px);
			background: var(--win-bg);
			backdrop-filter: blur(40px);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			display: flex;
			flex-direction: column;
			box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
			z-index: 100;
			overflow: hidden;
			transition: width 0.3s, height 0.3s, transform 0.3s, border-color 0.3s, opacity 0.3s;
		}

		.window.maximized {
			width: 100% !important;
			height: 100% !important;
			top: 0 !important;
			left: 0 !important;
			border-radius: 0;
		}

		.window.snap-left {
			width: 50% !important;
			height: 100% !important;
			top: 0 !important;
			left: 0 !important;
			border-radius: 0;
		}

		.window.snap-right {
			width: 50% !important;
			height: 100% !important;
			top: 0 !important;
			left: 50% !important;
			border-radius: 0;
		}

		.window.minimized {
			transform: scale(0.8) translateY(100px);
			opacity: 0;
			pointer-events: none;
		}

		.window-header {
			padding: 12px 18px;
			background: rgba(255, 255, 255, 0.05);
			display: flex;
			justify-content: space-between;
			align-items: center;
			cursor: default;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		}

		.win-title {
			font-size: 13px;
			color: var(--accent-color);
			flex-grow: 1;
			text-align: center;
			pointer-events: none;
		}

		.win-controls {
			display: flex;
			gap: 8px;
		}

		.control {
			width: 12px;
			height: 12px;
			border-radius: 50%;
			cursor: pointer;
			transition: 0.2s;
		}

		.control:hover {
			filter: brightness(1.2);
			transform: scale(1.1);
		}

		.close {
			background: #FF5F57;
		}

		.min {
			background: #FFBD2E;
		}

		.max {
			background: #28C840;
		}

		.window-body {
			flex: 1;
			background: #fff;
			position: relative;
			overflow: auto;
		}

		.window-body iframe {
			width: 100%;
			height: 100%;
			border: none;
		}

		.drag-overlay {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			display: none;
			z-index: 5;
		}

		/* --- SETTINGS APP --- */
		.settings-container {
			padding: 20px;
			color: #fff;
			background: #111;
			height: 100%;
			overflow-y: auto;
		}

		.setting-section {
			margin-bottom: 25px;
			border-bottom: 1px solid #333;
			padding-bottom: 15px;
		}

		.setting-label {
			display: block;
			margin-bottom: 10px;
			font-size: 14px;
			color: var(--accent-color);
			font-weight: 600;
		}

		.setting-input {
			width: 100%;
			background: #222;
			border: 1px solid #444;
			color: #fff;
			padding: 8px;
			border-radius: 6px;
			margin-bottom: 10px;
		}

		.color-options {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
		}

		.color-circle {
			width: 35px;
			height: 35px;
			border-radius: 50%;
			cursor: pointer;
			border: 2px solid transparent;
			transition: transform 0.2s;
		}

		.color-circle:hover {
			transform: scale(1.1);
			border-color: #fff;
		}

		.wallpaper-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
			gap: 12px;
			margin-top: 10px;
		}

		.wallpaper-option {
			height: 80px;
			border-radius: 10px;
			background-size: cover;
			background-position: center;
			cursor: pointer;
			border: 2px solid rgba(255, 255, 255, 0.1);
			transition: all 0.2s;
			position: relative;
		}

		.wallpaper-option:hover {
			transform: scale(1.05);
			border-color: var(--accent-color);
			box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
		}

		.wallpaper-name {
			position: absolute;
			bottom: 0;
			left: 0;
			width: 100%;
			background: rgba(0, 0, 0, 0.7);
			color: #fff;
			font-size: 9px;
			padding: 4px;
			text-align: center;
			border-bottom-left-radius: 8px;
			border-bottom-right-radius: 8px;
		}

		/* --- TERMINAL EMULATOR --- */
		.terminal-body {
			background-color: var(--term-bg);
			color: #c0caf5;
			font-family: 'Fira Code', 'Courier New', monospace !important;
			padding: 20px;
			height: 100%;
			overflow-y: auto;
			font-size: 14px;
			text-align: left;
			line-height: 1.5;
		}

		.term-line {
			margin-bottom: 2px;
			white-space: pre-wrap;
			font-family: inherit;
		}

		.term-prompt {
			color: var(--term-blue);
			font-weight: bold;
			margin-right: 8px;
		}

		.term-input {
			background: transparent;
			border: none;
			color: #fff;
			font-family: inherit;
			font-size: 14px;
			outline: none;
			flex: 1;
			caret-color: var(--term-green);
		}

		/* NEOFETCH GRID STYLE */
		.fetch-grid {
			display: flex;
			gap: 30px;
			align-items: flex-start;
			padding: 15px;
			margin-top: 10px;
			margin-bottom: 15px;
		}

		.os-logo-icon {
			font-size: 100px;
			color: var(--accent-color);
			filter: drop-shadow(0 0 15px rgba(125, 212, 255, 0.3));
			margin-top: 10px;
		}

		.fetch-info {
			display: flex;
			flex-direction: column;
			justify-content: center;
		}

		.fetch-info div {
			margin-bottom: 4px;
		}

		.acc {
			color: var(--term-blue);
			font-weight: bold;
			margin-right: 5px;
		}

		/* --- FILES APP --- */
		.file-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
			gap: 15px;
			padding: 20px;
			min-height: 100%;
		}

		.file-item {
			display: flex;
			flex-direction: column;
			align-items: center;
			text-align: center;
			cursor: pointer;
			padding: 10px;
			border-radius: 10px;
			transition: 0.2s;
			color: #333;
		}

		.file-item:hover {
			background: rgba(0, 0, 0, 0.05);
		}

		.file-icon {
			font-size: 40px;
			margin-bottom: 8px;
			color: var(--accent-color);
		}

		.file-name {
			font-size: 12px;
			word-break: break-all;
			color: #333;
		}

		/* --- DOCK / TASKBAR --- */
		#taskbar {
			position: fixed;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			height: 70px;
			background: var(--dock-bg);
			backdrop-filter: blur(35px);
			border: 1px solid var(--glass-border);
			border-radius: 22px;
			display: flex;
			align-items: center;
			padding: 0 15px;
			z-index: 9000;
			gap: 15px;
			transition: transform 0.4s cubic-bezier(0.2, 0, 0.2, 1), opacity 0.4s;
			min-width: 450px;
			justify-content: space-between;
		}

		#taskbar.hidden {
			transform: translate(-50%, 150%);
			opacity: 0;
			pointer-events: none;
			z-index: 0 !important;
		}

		#dock-trigger {
			position: fixed;
			bottom: 0;
			left: 0;
			width: 100%;
			height: 15px;
			z-index: 9999;
			background: transparent;
		}

		#taskbar-apps {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 0 15px;
			border-left: 1px solid rgba(255, 255, 255, 0.1);
			border-right: 1px solid rgba(255, 255, 255, 0.1);
			height: 100%;
			flex-grow: 1;
			justify-content: center;
		}

		.taskbar-item {
			width: 50px;
			height: 50px;
			border-radius: 12px;
			background: rgba(255, 255, 255, 0.05);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 22px;
			color: rgba(255, 255, 255, 0.7);
			cursor: pointer;
			transition: all 0.2s;
			position: relative;
			border: 1px solid transparent;
		}

		.taskbar-item:hover {
			background: rgba(255, 255, 255, 0.15);
			transform: translateY(-5px);
			color: #fff;
		}

		.taskbar-item.active {
			border-bottom: 3px solid var(--accent-color);
			background: rgba(255, 255, 255, 0.1);
			color: var(--accent-color);
		}

		.taskbar-item.focused {
			box-shadow: 0 0 10px var(--accent-color);
			border-color: var(--glass-border);
		}

		.taskbar-system {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.shield-btn,
		.add-btn {
			display: flex;
			align-items: center;
			justify-content: center;
			background: rgba(255, 255, 255, 0.1);
			border-radius: 15px;
			cursor: pointer;
			border: 1px solid var(--glass-border);
			color: var(--accent-color);
			transition: 0.2s;
			height: 45px;
		}

		.shield-btn {
			gap: 12px;
			padding: 8px 18px;
		}

		.add-btn {
			width: 45px;
			font-size: 18px;
			border-radius: 50%;
		}

		.shield-btn:hover,
		.add-btn:hover {
			background: rgba(255, 255, 255, 0.2);
			transform: scale(1.05);
		}

		/* --- PERFORMANCE MODE --- */
		body.perf-mode .window,
		body.perf-mode #taskbar,
		body.perf-mode .icon-visual,
		body.perf-mode #music-player,
		body.perf-mode #context-menu {
			backdrop-filter: none !important;
			box-shadow: none !important;
			transition: none !important;
		}

		body.perf-mode .window {
			background: rgba(10, 15, 25, 1);
			border: 1px solid #333;
		}

		body.perf-mode #taskbar {
			background: rgba(10, 20, 30, 0.95);
			border: 1px solid #444;
		}

		.perf-active .shield-btn i {
			color: #ffd700 !important;
		}

		#clock {
			font-size: 16px;
			font-weight: 500;
			color: var(--accent-color);
			text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
			padding-left: 5px;
			cursor: pointer;
		}

		/* --- MUSIC PLAYER --- */
		#music-player {
			position: fixed;
			top: 100px;
			right: 20px;
			width: 320px;
			background: rgba(10, 15, 25, 0.9);
			backdrop-filter: blur(25px);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			padding: 20px;
			z-index: 8000;
			color: #fff;
			transition: transform 0.3s ease;
			transform: translateX(360px);
			display: flex;
			flex-direction: column;
			max-height: 80vh;
		}

		#music-player.active {
			transform: translateX(0);
		}

		.music-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
		}

		.music-title {
			font-weight: 700;
			color: var(--accent-color);
		}

		.music-close {
			cursor: pointer;
			color: #FF5F57;
		}

		.search-container {
			display: flex;
			gap: 5px;
			margin-bottom: 15px;
		}

		.music-search {
			flex: 1;
			background: rgba(255, 255, 255, 0.1);
			border: 1px solid rgba(255, 255, 255, 0.2);
			padding: 8px 12px;
			border-radius: 10px;
			color: #fff;
			outline: none;
			font-size: 12px;
		}

		.search-btn {
			background: var(--accent-color);
			border: none;
			border-radius: 8px;
			width: 35px;
			cursor: pointer;
			color: #000;
		}

		.radio-btn {
			width: 100%;
			background: rgba(255, 255, 255, 0.1);
			border: 1px solid rgba(255, 255, 255, 0.2);
			color: #fff;
			padding: 8px;
			border-radius: 10px;
			margin-bottom: 15px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			font-size: 12px;
			transition: 0.2s;
		}

		.results-list {
			flex: 1;
			overflow-y: auto;
			margin-bottom: 15px;
			display: flex;
			flex-direction: column;
			gap: 8px;
			max-height: 150px;
		}

		.song-result {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 8px;
			background: rgba(255, 255, 255, 0.05);
			border-radius: 8px;
			cursor: pointer;
		}

		.song-img {
			width: 35px;
			height: 35px;
			border-radius: 4px;
			background: #333;
			object-fit: cover;
		}

		.song-name {
			font-size: 12px;
			font-weight: bold;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.song-artist {
			font-size: 10px;
			color: #aaa;
		}

		.custom-player-ui {
			background: rgba(255, 255, 255, 0.05);
			padding: 15px;
			border-radius: 12px;
			display: flex;
			flex-direction: column;
			gap: 10px;
			border: 1px solid rgba(255, 255, 255, 0.1);
		}

		.progress-area {
			display: flex;
			align-items: center;
			gap: 10px;
			font-size: 10px;
			color: #aaa;
		}

		.progress-bar {
			flex: 1;
			height: 4px;
			background: rgba(255, 255, 255, 0.2);
			border-radius: 2px;
			cursor: pointer;
			position: relative;
		}

		.progress-fill {
			width: 0%;
			height: 100%;
			background: var(--accent-color);
			border-radius: 2px;
		}

		.player-buttons {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 20px;
		}

		.p-btn {
			background: none;
			border: none;
			color: #fff;
			cursor: pointer;
			font-size: 16px;
			transition: 0.2s;
		}

		.play-toggle {
			width: 35px;
			height: 35px;
			border-radius: 50%;
			background: var(--accent-color);
			color: #000;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 14px;
		}

		.vol-slider {
			-webkit-appearance: none;
			width: 100%;
			height: 3px;
			background: rgba(255, 255, 255, 0.2);
			border-radius: 2px;
			outline: none;
			margin-top: 5px;
		}

		.vol-slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			width: 10px;
			height: 10px;
			border-radius: 50%;
			background: var(--accent-color);
			cursor: pointer;
		}

		#toggle-music {
			position: fixed;
			bottom: 100px;
			right: 20px;
			width: 50px;
			height: 50px;
			background: var(--dock-bg);
			border: 1px solid var(--glass-border);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			color: var(--accent-color);
			z-index: 7000;
			cursor: pointer;
			backdrop-filter: blur(10px);
			transition: 0.2s;
			opacity: 1;
		}

		#toggle-music.hidden-ui {
			transform: scale(0);
			opacity: 0;
			pointer-events: none;
		}

		/* --- CONTEXT MENU & MODALS --- */
		#context-menu {
			position: fixed;
			z-index: 20000;
			display: none;
			background: rgba(15, 20, 30, 0.95);
			backdrop-filter: blur(10px);
			border: 1px solid var(--glass-border);
			border-radius: 10px;
			padding: 5px;
			min-width: 150px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
		}

		.ctx-item {
			padding: 10px 15px;
			color: #fff;
			font-size: 13px;
			cursor: pointer;
			border-radius: 6px;
			display: flex;
			align-items: center;
			gap: 10px;
			transition: 0.2s;
		}

		.ctx-item:hover {
			background: rgba(255, 255, 255, 0.1);
		}

		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.75);
			backdrop-filter: blur(8px);
			z-index: 10000;
			display: none;
			align-items: center;
			justify-content: center;
		}

		.modal-content {
			width: 400px;
			background: #0f151c;
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			padding: 30px;
			display: flex;
			flex-direction: column;
			gap: 15px;
			box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
		}

		.modal-content h3 {
			color: var(--accent-color);
			margin-bottom: 5px;
		}

		.modal-content input {
			background: rgba(255, 255, 255, 0.1);
			border: 1px solid rgba(255, 255, 255, 0.2);
			padding: 12px;
			border-radius: 10px;
			color: #fff;
			outline: none;
			font-family: inherit;
		}

		.modal-btns {
			display: flex;
			gap: 10px;
			justify-content: flex-end;
			margin-top: 10px;
		}

		.modal-btn {
			padding: 8px 16px;
			border-radius: 8px;
			border: none;
			cursor: pointer;
			font-weight: 600;
		}

		.btn-cancel {
			background: rgba(255, 255, 255, 0.1);
			color: #fff;
		}

		.btn-save {
			background: var(--accent-color);
			color: #000;
		}
	</style>
</head>

<body>
	<div id="os-brand">EdulearnOS</div>
	<canvas id="lifeblood-canvas"></canvas>
	<div id="snap-preview"></div>
	<div id="dock-trigger"></div>
	<div id="desktop"></div>

	<input type="file" id="file-uploader" style="display: none;" onchange="processFileImport(this)">
	<div id="context-menu"></div>

	<div id="toggle-music" onclick="toggleMusicPlayer()">
		<i class="fa-solid fa-music"></i>
	</div>

	<div id="music-player">
		<div class="music-header">
			<span class="music-title">SonicBar</span>
			<i class="fa-solid fa-times music-close" onclick="toggleMusicPlayer()"></i>
		</div>

		<div style="margin-bottom:5px; font-size:10px; color:#aaa;">Load SoundCloud/Tidal/MP3 URL:</div>
		<div class="search-container">
			<input type="text" class="music-search" id="direct-url-input" placeholder="Paste URL..." onchange="playDirect(this.value)">
			<button class="search-btn" onclick="playDirect(document.getElementById('direct-url-input').value)">
                <i class="fa-solid fa-play"></i>
            </button>
		</div>

		<div id="embed-container" style="display:none;"></div>

		<div id="classic-player-ui">
			<div class="radio-btn" onclick="playLofiRadio()">
				<i class="fa-solid fa-radio"></i> Start Lofi Radio
			</div>

			<div class="search-container">
				<input type="text" class="music-search" id="music-search-input" placeholder="Search iTunes..." onkeydown="if(event.key==='Enter') searchMusic()">
				<button class="search-btn" onclick="searchMusic()">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
			</div>

			<div class="results-list" id="music-results"></div>

			<div class="now-playing" id="now-playing-text">Not Playing</div>

			<div class="custom-player-ui">
				<div class="progress-area">
					<span id="curr-time">0:00</span>
					<div class="progress-bar" id="progress-bar" onclick="seekAudio(event)">
						<div class="progress-fill" id="progress-fill"></div>
					</div>
					<span id="dur-time">0:00</span>
				</div>
				<div class="player-buttons">
					<button class="p-btn" onclick="skip(-5)"><i class="fa-solid fa-backward"></i></button>
					<button class="p-btn play-toggle" id="play-pause-btn" onclick="togglePlayState()">
                        <i class="fa-solid fa-play"></i>
                    </button>
					<button class="p-btn" onclick="skip(5)"><i class="fa-solid fa-forward"></i></button>
				</div>
				<input type="range" class="vol-slider" min="0" max="1" step="0.05" value="0.8" oninput="setVolume(this.value)">
            </div>
			</div>

			<audio id="os-audio" style="display:none;" crossorigin="anonymous" ontimeupdate="updateProgress()"
				onended="onAudioEnded()"></audio>
		</div>

		<div id="custom-app-modal" class="modal-overlay">
			<div class="modal-content">
				<h3>Create New App</h3>
				<input type="text" id="app-name-input" placeholder="App Name (e.g., My Game)">
				<input type="text" id="app-url-input" placeholder="URL (e.g., https://example.com)">
				<div class="modal-btns">
					<button class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
					<button class="modal-btn btn-save" onclick="saveCustomApp()">Create App</button>
				</div>
			</div>
		</div>

		<div id="taskbar">
			<div class="taskbar-system"></div>
			<div id="taskbar-apps"></div>
			<div class="taskbar-system">
				<div class="add-btn" onclick="openSettingsApp()" title="System Settings">
					<i class="fa-solid fa-gear"></i>
				</div>
				<div class="shield-btn" id="perf-btn" onclick="togglePerformanceMode()" title="Toggle Performance Mode">
					<i class="fa-solid fa-bolt"></i>
				</div>
				<div class="add-btn" onclick="openModal()" title="Add Custom App">
					<i class="fa-solid fa-plus"></i>
				</div>
				<div id="clock" onclick="togglePerformanceMode()">12:00</div>
			</div>
		</div>

		<script>
			// FIX 1: Initialize the file storage so importing works
            let virtualFiles = JSON.parse(localStorage.getItem('edu_files')) || [];

			/* =========================================
               DATA & CONFIGURATION
               ========================================= */
            const colors = [
                { name: "Windows Blue", hex: "#0078d4", rgb: "0, 120, 212" }, // 0
                { name: "Ubuntu Orange", hex: "#E95420", rgb: "233, 84, 32" }, // 1
                { name: "Mint Green", hex: "#87cf3e", rgb: "135, 207, 62" }, // 2
                { name: "Google Blue", hex: "#4285F4", rgb: "66, 133, 244" }, // 3
                { name: "Kali Blue", hex: "#557CDB", rgb: "85, 124, 219" }, // 4
                { name: "Fedora Blue", hex: "#3C6EB4", rgb: "60, 110, 180" }, // 5
                { name: "Rose Red", hex: "#f7768e", rgb: "247, 118, 142" }, // 6
                { name: "Golden Yellow", hex: "#e0af68", rgb: "224, 175, 104" }, // 7
                { name: "Purple", hex: "#bb9af7", rgb: "187, 154, 247" } // 8
            ];
            
            const wallpapers = [
                { name: "Windows 11 Bloom", url: "https://blogs.windows.com/wp-content/uploads/sites/2/2021/10/Windows-11-Bloom-Screensaver-Dark-scaled.jpg", colorIndex: 0 },
                { name: "Ubuntu 22.04", url: "https://ubuntucommunity.s3.us-east-2.amazonaws.com/original/2X/0/0921cb27d5604b464218a64ae88a3f43c7b7371a.png", colorIndex: 1 },
                { name: "Linux Mint Victoria", url: "https://fc06.deviantart.net/fs70/f/2010/085/8/a/LM9_by_Zwopper.png", colorIndex: 2 },
                { name: "ChromeOS Default", url: "https://9to5google.com/wp-content/uploads/sites/4/2017/02/chromeos_newdefaultwall_1-e1487111985183.png?w=1024", colorIndex: 3 },
                { name: "Kali Linux 2023", url: "https://www.kali.org/wallpapers/images/2020.4/kali-neon.png", colorIndex: 4 },
                { name: "Fedora Standard", url: "https://fedoraproject.org/w/uploads/thumb/6/6d/F33_wallpaper_night.jpg/200px-F33_wallpaper_night.jpg", colorIndex: 5 },
                { name: "Abstract Red", url: "https://images.unsplash.com/photo-1541701494587-cb58502866ab?q=80&w=1000&auto=format&fit=crop", colorIndex: 6 },
                { name: "Abstract Gold", url: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTkeJ_hnuTnkjFx3uCY2DF_EtJzLqAZgtlGcQ&s", colorIndex: 7 }
            ];

            let isPerfMode = false;
            let animId;
            let openWindows = {};
            let taskbarItems = {};
            let currentParticleRGB = "0, 120, 212";

            // Load saved settings
            const savedColorIdx = localStorage.getItem('edu_color_idx');
            if (savedColorIdx !== null) setAccentColor(parseInt(savedColorIdx));
            
            const savedWall = localStorage.getItem('edu_wallpaper');
            if (savedWall) document.body.style.backgroundImage = `url('${savedWall}')`;

            const savedCustomApps = JSON.parse(localStorage.getItem('customApps')) || [];

            function setAccentColor(index) {
                const c = colors[index];
                document.documentElement.style.setProperty('--accent-color', c.hex);
                document.documentElement.style.setProperty('--glass-border', `rgba(${c.rgb}, 0.3)`);
                currentParticleRGB = c.rgb;
                localStorage.setItem('edu_color_idx', index);
                localStorage.setItem('edu_color_hex', c.hex);
            }

            function setWallpaper(index) {
                if(wallpapers[index]) {
                    const w = wallpapers[index];
                    document.body.style.backgroundImage = `url('${w.url}')`;
                    localStorage.setItem('edu_wallpaper', w.url);
                    // Automatically apply the preset accent color
                    if (w.colorIndex !== undefined && colors[w.colorIndex]) {
                        setAccentColor(w.colorIndex);
                    }
                }
            }

            function togglePerformanceMode(forceVal) {
                const btn = document.getElementById('perf-btn');
                const newState = (forceVal !== undefined) ? forceVal : !isPerfMode;

                if (newState) {
                    isPerfMode = true;
                    document.body.classList.add('perf-mode');
                    btn.classList.add('perf-active');
                    cancelAnimationFrame(animId);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                } else {
                    isPerfMode = false;
                    document.body.classList.remove('perf-mode');
                    btn.classList.remove('perf-active');
                    anim();
                }
            }

            /* =========================================
               PARTICLE BACKGROUND
               ========================================= */
            const canvas = document.getElementById('lifeblood-canvas');
            const ctx = canvas.getContext('2d');
            let particles = [];

            const resize = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            };
            window.addEventListener('resize', resize);
            resize();

            class P {
                constructor() { this.reset(); }
                reset() {
                    this.x = Math.random() * canvas.width;
                    this.y = canvas.height + 20;
                    this.s = Math.random() * 2 + 1;
                    this.vy = Math.random() * -0.7 - 0.2;
                    this.o = Math.random() * 0.5 + 0.1;
                }
                update() {
                    this.y += this.vy;
                    if (this.y < -10) this.reset();
                }
                draw() {
                    ctx.fillStyle = `rgba(${currentParticleRGB}, ${this.o})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.s, 0, Math.PI*2);
                    ctx.fill();
                }
            }

            for(let i=0; i<50; i++) particles.push(new P());

            function anim() {
                if(isPerfMode) return;
                ctx.clearRect(0,0,canvas.width,canvas.height);
                particles.forEach(p=>{p.update();p.draw();});
                animId = requestAnimationFrame(anim);
            }
            anim();

            /* =========================================
               APPLICATION REGISTRY
               ========================================= */
            let apps = [
                { id: 'sc', name: 'Browser', icon: 'fa-solid fa-globe', url: atob('Li9zY2llbmNlLw==') },
                { id: 'gn', name: 'Games', icon: 'fa-solid fa-gamepad', url: atob('Li9tYXRoL2duLW1hdGguaHRtbA==') },
                { id: 'term', name: 'Terminal', icon: 'fa-solid fa-terminal', isSystem: true },
                { id: 'e2e', name: 'E2EV2', icon: 'fa-solid fa-lock', url: atob('Li9lMmV2Mi5odG1s') },
                { id: 'dm', name: 'Dosmes AI', icon: 'fa-solid fa-chart-line', url: atob('aHR0cHM6Ly9kZXNtb3MubGF0') },
                { id: 'fs', name: 'My Files', icon: 'fa-solid fa-folder-open', isSystem: true },
                { id: 'gc', name: 'Graphing', icon: 'fa-solid fa-chart-simple', url: atob('Li9ncmFwaGNhbGMuaHRtbA==') },
                { id: 'sp-prod', name: 'Super Productivity', icon: 'fa-solid fa-check-double', url: 'https://app.super-productivity.com' },
                { id: 'p', name: 'Paint', icon: 'fa-solid fa-palette', url: atob('Li9wYWludC5odG1s') },
                { id: 'p8', name: 'Pixel 8', icon: 'fa-solid fa-border-all', url: atob('Li9waXhlbDguaHRtbA==') },
                { id: 'mp', name: 'Music', icon: 'fa-solid fa-music', url: atob('Li9tdXNpY3BsYXllci5odG1s') },
                { id: 'te', name: 'Text Editor', icon: 'fa-solid fa-file-lines', url: atob('Li90ZXh0ZWRpdG9yLmh0bWw=') },
                { id: 'cr', name: 'Code Runner', icon: 'fa-solid fa-code', url: atob('Li9jb2RlcnVubmVyLmh0bWw=') },
                { id: 'dc', name: 'Discord', icon: 'fa-brands fa-discord', url: atob('aHR0cHM6Ly9kaXNjb3JkLmdnL0VQbTVxbktrWU4=') },
                { id: 'cl', name: 'Changelog', icon: 'fa-solid fa-circle-info', url: atob('Li9pbmZvLmh0bWw=') },
                { id: 'tools', name: 'Tools', icon: 'fa-solid fa-wrench', url: atob('Li90b29scy5odG1s') }, // Added Tools App
                ...savedCustomApps
            ];

            const desktop = document.getElementById('desktop');

            // --- NEW: Global Drag Handling for Icons (for better performance & grid snap) ---
            let draggedIcon = null;
            let dragOffset = [0, 0];
            let originalIconPos = { left: 0, top: 0 }; // Store starting position

            function renderIcons() {
                desktop.innerHTML = '';
                const startX = 30;
                const startY = 30;
                const gridX = 100;
                const gridY = 100;
                
                // Switch to Vertical Stacking (Column-Major) to put apps "on the left"
                const maxRows = Math.floor((window.innerHeight - 80) / gridY);

                apps.forEach((app, index) => {
                    const div = document.createElement('div');
                    div.className = 'icon';
                    
                    // Column-Major Grid Logic
                    const row = index % maxRows;
                    const col = Math.floor(index / maxRows);

                    div.style.left = (startX + col * gridX) + 'px';
                    div.style.top = (startY + row * gridY) + 'px';
                    
                    div.innerHTML = `<div class="icon-visual"><i class="${app.icon}"></i></div><span>${app.name}</span>`;
                    
                    div.addEventListener('mousedown', (e) => {
                        if(e.button !== 0) return;
                        draggedIcon = div;
                        // Save the original position before dragging starts
                        originalIconPos = { left: div.style.left, top: div.style.top };
                        
                        dragOffset = [div.offsetLeft - e.clientX, div.offsetTop - e.clientY];
                        div.classList.add('is-dragging');
                    });

                    div.addEventListener('dblclick', () => {
                        if(app.isSystem) {
                            if(app.id === 'term') openTerminal();
                            if(app.id === 'fs') openFilesApp();
                        } else {
                            createWindow(app.id, app.name, `<iframe src="${app.url}"></iframe>`, app.icon);
                        }
                    });
                    
                    div.addEventListener('contextmenu', (e) => {
                        e.stopPropagation();
                        showContextMenu(e, 'app', app);
                    });

                    desktop.appendChild(div);
                });
            }

            // Global Mouse Events for Icon Dragging & Snapping
            document.addEventListener('mousemove', (e) => {
                if(draggedIcon) {
                    draggedIcon.style.left = (e.clientX + dragOffset[0]) + 'px';
                    draggedIcon.style.top = (e.clientY + dragOffset[1]) + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                if(draggedIcon) {
                    const icon = draggedIcon;
                    draggedIcon = null;
                    icon.classList.remove('is-dragging');

                    // --- GRID SNAP LOGIC ---
                    const gridX = 100;
                    const gridY = 100;
                    const rawX = parseInt(icon.style.left);
                    const rawY = parseInt(icon.style.top);
                    
                    // Snap to nearest 100px grid (offset by 30px margin)
                    const snapCol = Math.round((rawX - 30) / gridX);
                    const snapRow = Math.round((rawY - 30) / gridY);
                    
                    // Ensure it doesn't snap off-screen (negative coords)
                    const finalX = Math.max(30, 30 + snapCol * gridX);
                    const finalY = Math.max(30, 30 + snapRow * gridY);

                    // --- COLLISION DETECTION (BOUNCE OFF) ---
                    let isOccupied = false;
                    const allIcons = document.querySelectorAll('.icon');
                    
                    allIcons.forEach(other => {
                        if (other === icon) return; // Skip checking against itself

                        // Get the position of the other icon
                        const otherX = parseInt(other.style.left);
                        const otherY = parseInt(other.style.top);

                        // Check if the other icon is at the destination coordinates
                        // (Using a small tolerance of 5px to be safe)
                        if (Math.abs(otherX - finalX) < 5 && Math.abs(otherY - finalY) < 5) {
                            isOccupied = true;
                        }
                    });

                    if (isOccupied) {
                        // If occupied, BOUNCE BACK to the saved original position
                        icon.style.left = originalIconPos.left;
                        icon.style.top = originalIconPos.top;
                    } else {
                        // If free, apply the new snap position
                        icon.style.left = finalX + 'px';
                        icon.style.top = finalY + 'px';
                    }
                }
            });


            /* =========================================
               WINDOW MANAGER
               ========================================= */
            const preview = document.getElementById('snap-preview');
            let zIndexCounter = 100;

            function createWindow(id, title, content, iconClass) {
                // If single instance check required, do here.
                // For now, allow multiples or just check openWindows[id]
                
                const winId = 'win-' + Date.now();
                const win = document.createElement('div');
                win.className = 'window';
                win.id = winId;
                win.style.left = (100 + (Object.keys(openWindows).length * 30)) + 'px';
                win.style.top = (50 + (Object.keys(openWindows).length * 30)) + 'px';
                win.style.zIndex = ++zIndexCounter;

                win.innerHTML = `
                    <div class="window-header" onmousedown="startWinDrag(event, '${winId}')" ondblclick="toggleMaximize('${winId}')">
                        <div class="win-controls">
                            <div class="control close" onclick="closeWindow('${winId}')"></div>
                            <div class="control min" onclick="minimizeWindow('${winId}')"></div>
                            <div class="control max" onclick="toggleMaximize('${winId}')"></div>
                        </div>
                        <div class="win-title">${title}</div>
                        <div style="width:50px"></div>
                    </div>
                    <div class="window-body">
                        <div class="drag-overlay"></div>
                        ${content}
                    </div>
                    <div class="resizer" style="position:absolute;bottom:0;right:0;width:15px;height:15px;cursor:se-resize;" onmousedown="startWinResize(event, '${winId}')"></div>
                `;

                // Add to DOM
                document.body.appendChild(win);
                openWindows[winId] = { id: winId, title, icon: iconClass, minimized: false, maximized: false };

                // Add to Taskbar
                addToTaskbar(winId, title, iconClass);
                
                // Focus newly created
                focusWindow(winId);

                // Add click listener to focus
                win.addEventListener('mousedown', () => focusWindow(winId));
            }

            function closeWindow(wid) {
                const w = document.getElementById(wid);
                if(w) {
                    w.style.opacity = '0';
                    w.style.transform = 'scale(0.9)';
                    setTimeout(() => w.remove(), 200);
                }
                delete openWindows[wid];
                removeFromTaskbar(wid);
            }

            function minimizeWindow(wid) {
                const w = document.getElementById(wid);
                if(w) {
                    w.classList.add('minimized');
                    openWindows[wid].minimized = true;
                    updateTaskbarState(wid);
                }
            }

            function toggleMaximize(wid) {
                const w = document.getElementById(wid);
                if(!w) return;
                
                if(openWindows[wid].maximized) {
                    w.classList.remove('maximized');
                    openWindows[wid].maximized = false;
                } else {
                    w.classList.add('maximized');
                    openWindows[wid].maximized = true;
                }
            }

            function focusWindow(wid) {
                const w = document.getElementById(wid);
                if(!w) return;
                
                // Restore if minimized
                if(openWindows[wid].minimized) {
                    w.classList.remove('minimized');
                    openWindows[wid].minimized = false;
                    updateTaskbarState(wid);
                }

                // Bring to front
                w.style.zIndex = ++zIndexCounter;
                
                // Update taskbar visuals
                document.querySelectorAll('.taskbar-item').forEach(i => i.classList.remove('focused'));
                const tbItem = document.getElementById('tb-' + wid);
                if(tbItem) tbItem.classList.add('focused');
            }

            /* --- WINDOW DRAGGING & SNAPPING --- */
            let draggedWin = null;
            let winDragOff = [0, 0];

            function startWinDrag(e, wid) {
                if(e.target.closest('.win-controls')) return;
                const w = document.getElementById(wid);
                draggedWin = w;
                winDragOff = [e.clientX - w.offsetLeft, e.clientY - w.offsetTop];
                
                w.querySelector('.drag-overlay').style.display = 'block'; // Block iframes
                focusWindow(wid);
                document.body.style.cursor = 'move';
            }

            document.addEventListener('mousemove', (e) => {
                if(draggedWin) {
                    // Snap Preview Logic
                    if(e.clientX < 20) {
                        preview.style.display = 'block';
                        preview.style.top = '0'; preview.style.left = '0';
                        preview.style.width = '50%'; preview.style.height = '100%';
                        preview.style.borderRadius = '0 20px 20px 0';
                    } else if(e.clientX > window.innerWidth - 20) {
                        preview.style.display = 'block';
                        preview.style.top = '0'; preview.style.left = '50%';
                        preview.style.width = '50%'; preview.style.height = '100%';
                        preview.style.borderRadius = '20px 0 0 20px';
                    } else if(e.clientY < 20) {
                        preview.style.display = 'block';
                        preview.style.top = '0'; preview.style.left = '0';
                        preview.style.width = '100%'; preview.style.height = '100%';
                        preview.style.borderRadius = '0';
                    } else {
                        preview.style.display = 'none';
                    }

                    // Move Window
                    let newLeft = e.clientX - winDragOff[0];
                    let newTop = e.clientY - winDragOff[1];
                    draggedWin.style.left = newLeft + 'px';
                    draggedWin.style.top = newTop + 'px';
                    
                    // Reset snapped state if dragging
                    if(draggedWin.classList.contains('maximized')) {
                        draggedWin.classList.remove('maximized');
                        openWindows[draggedWin.id].maximized = false;
                    }
                    draggedWin.classList.remove('snap-left', 'snap-right');
                }
            });

            document.addEventListener('mouseup', (e) => {
                if(draggedWin) {
                    draggedWin.querySelector('.drag-overlay').style.display = 'none';
                    
                    // Apply Snap
                    if(e.clientX < 20) draggedWin.classList.add('snap-left');
                    else if(e.clientX > window.innerWidth - 20) draggedWin.classList.add('snap-right');
                    else if(e.clientY < 20) {
                        draggedWin.classList.add('maximized');
                        openWindows[draggedWin.id].maximized = true;
                    }

                    draggedWin = null;
                    preview.style.display = 'none';
                    document.body.style.cursor = 'default';
                }
            });

            /* --- TASKBAR LOGIC --- */
            function addToTaskbar(wid, title, icon) {
                const tb = document.getElementById('taskbar-apps');
                const div = document.createElement('div');
                div.className = 'taskbar-item active focused';
                div.id = 'tb-' + wid;
                div.innerHTML = `<i class="${icon}"></i>`;
                div.title = title;
                div.onclick = () => {
                    const w = document.getElementById(wid);
                    if(w.classList.contains('minimized')) focusWindow(wid);
                    else if(w.style.zIndex == zIndexCounter) minimizeWindow(wid); // Toggle min if focused
                    else focusWindow(wid);
                };
                tb.appendChild(div);
            }

            function removeFromTaskbar(wid) {
                const el = document.getElementById('tb-' + wid);
                if(el) el.remove();
            }

            function updateTaskbarState(wid) {
                const el = document.getElementById('tb-' + wid);
                if(openWindows[wid].minimized) el.classList.remove('focused');
            }

            // Auto-hide Taskbar Logic
            const taskbar = document.getElementById('taskbar');
            document.getElementById('dock-trigger').addEventListener('mouseenter', () => {
                taskbar.classList.remove('hidden');
            });
            taskbar.addEventListener('mouseleave', () => {
                // Only hide if we have open maximized windows? OR just generally auto-hide
                // For this OS, let's auto-hide if a window is overlapping
                // But simplified: user wants macOS style dock usually
                // Let's keep it visible unless Fullscreen mode? 
                // For now, simple behavior:
                // taskbar.classList.add('hidden'); 
            });

            /* =========================================
               SYSTEM APPS (TERMINAL, FILES, SETTINGS)
               ========================================= */
            
            // --- TERMINAL ---
            function openTerminal() {
                const content = `
                    <div class="terminal-body" id="term-body" onclick="document.getElementById('term-input').focus()">
                        <div class="term-line">Welcome to EdulearnOS v1.0.0</div>
                        <div class="term-line">Type 'help' for available commands.</div>
                        <br>
                        <div class="term-line" id="term-output"></div>
                        <div style="display:flex;">
                            <span class="term-prompt">user@edulearnos:~$</span>
                            <input type="text" class="term-input" id="term-input" autocomplete="off" onkeydown="handleTerm(event)">
                        </div>
                    </div>
                `;
                createWindow('term-' + Date.now(), 'Terminal', content, 'fa-solid fa-terminal');
                setTimeout(() => document.getElementById('term-input').focus(), 100);
            }

            function handleTerm(e) {
                if(e.key === 'Enter') {
                    const input = e.target;
                    const val = input.value.trim();
                    const output = document.getElementById('term-output'); // This targets ONLY the active terminal? 
                    // Issue: This ID selector targets the FIRST terminal. 
                    // FIX: Traverse up to the window.
                    
                    const termBody = input.closest('.terminal-body');
                    const outContainer = termBody.querySelector('#term-output') || termBody.children[2]; // Fallback
                    
                    // Echo command
                    const cmdLine = document.createElement('div');
                    cmdLine.className = 'term-line';
                    cmdLine.innerHTML = `<span class="term-prompt">user@edulearnos:~$</span> ${val}`;
                    termBody.insertBefore(cmdLine, input.parentElement);

                    // Process Command
                    processCommand(val, termBody);

                    input.value = '';
                    termBody.scrollTop = termBody.scrollHeight;
                }
            }

            function processCommand(cmd, container) {
                const args = cmd.split(' ');
                const c = args[0].toLowerCase();
                let resp = '';

                switch(c) {
                    case 'help':
                        resp = "Available commands: help, clear, neofetch, ls, open, echo, date, reboot";
                        break;
                    case 'clear':
                        container.innerHTML = `
                             <div class="term-line" id="term-output"></div>
                             <div style="display:flex;">
                                <span class="term-prompt">user@edulearnos:~$</span>
                                <input type="text" class="term-input" id="term-input" autocomplete="off" onkeydown="handleTerm(event)">
                            </div>
                        `;
                        // Re-focus handled by click
                        return; 
                    case 'neofetch':
                        resp = `
                        <div class="fetch-grid">
                            <i class="fa-brands fa-linux os-logo-icon"></i>
                            <div class="fetch-info">
                                <div><span class="acc">OS:</span> EdulearnOS Web x86_64</div>
                                <div><span class="acc">Host:</span> Web Browser</div>
                                <div><span class="acc">Kernel:</span> 5.15.0-js-generic</div>
                                <div><span class="acc">Uptime:</span> Just now</div>
                                <div><span class="acc">Packages:</span> ${apps.length} (dpkg)</div>
                                <div><span class="acc">Shell:</span> bash 5.1.16</div>
                                <div><span class="acc">Resolution:</span> ${window.innerWidth}x${window.innerHeight}</div>
                                <div><span class="acc">Theme:</span> Glass Dark</div>
                                <div><span class="acc">Icons:</span> FontAwesome 6</div>
                            </div>
                        </div>
                        `;
                        break;
                    case 'ls':
                        resp = apps.map(a => `<span style="margin-right:10px;color:#a9b1d6">${a.name}</span>`).join('');
                        break;
                    case 'date':
                        resp = new Date().toString();
                        break;
                    case 'reboot':
                        location.reload();
                        break;
                    case 'echo':
                        resp = args.slice(1).join(' ');
                        break;
                    case 'open':
                         // Open app by name
                         const appName = args.slice(1).join(' ').toLowerCase();
                         const found = apps.find(a => a.name.toLowerCase() === appName);
                         if(found) {
                             if(found.isSystem) {
                                 if(found.id === 'term') openTerminal();
                                 if(found.id === 'fs') openFilesApp();
                             } else {
                                 createWindow(found.id, found.name, `<iframe src="${found.url}"></iframe>`, found.icon);
                             }
                             resp = `Opening ${found.name}...`;
                         } else {
                             resp = `App '${appName}' not found.`;
                         }
                         break;
                    case '':
                        resp = ''; break;
                    default:
                        resp = `bash: ${c}: command not found`;
                }

                if(resp) {
                    const rDiv = document.createElement('div');
                    rDiv.className = 'term-line';
                    rDiv.innerHTML = resp;
                    // insert before the input line
                    container.insertBefore(rDiv, container.lastElementChild);
                }
            }

            // --- FILES APP ---
            function openFilesApp() {
                // Combine system files (apps) and virtual user files
                // For simplicity, just showing downloaded files
                renderFilesWindow();
            }

            function renderFilesWindow() {
                const content = `
                    <div style="padding:10px;border-bottom:1px solid #eee;">
                        <button onclick="document.getElementById('file-uploader').click()">Import File</button>
                        <button onclick="clearFiles()">Clear All</button>
                    </div>
                    <div class="file-grid" id="file-list-container">
                        ${getFilesHTML()}
                    </div>
                `;
                createWindow('files', 'My Files', content, 'fa-solid fa-folder-open');
            }

            function getFilesHTML() {
                if(virtualFiles.length === 0) return '<div style="width:100%;text-align:center;color:#666;margin-top:20px;">No files imported.</div>';
                
                return virtualFiles.map((f, i) => `
                    <div class="file-item" onclick="openFile(${i})">
                        <i class="fa-solid fa-file file-icon"></i>
                        <div class="file-name">${f.name}</div>
                    </div>
                `).join('');
            }

            function processFileImport(input) {
                const file = input.files[0];
                if(!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    virtualFiles.push({
                        name: file.name,
                        type: file.type,
                        content: e.target.result
                    });
                    localStorage.setItem('edu_files', JSON.stringify(virtualFiles));
                    
                    // Refresh window if open
                    const w = document.getElementById('files');
                    if(w) {
                        const grid = w.querySelector('.file-grid');
                        if(grid) grid.innerHTML = getFilesHTML();
                    }
                };
                reader.readAsDataURL(file);
            }

            function openFile(index) {
                const f = virtualFiles[index];
                // Simple viewer
                let content = '';
                if(f.type.startsWith('image')) {
                    content = `<img src="${f.content}" style="max-width:100%;max-height:100%;">`;
                } else if(f.type.startsWith('text') || f.name.endsWith('.txt') || f.name.endsWith('.md')) {
                    // Need to decode base64 for text? readAsDataURL gives base64
                    // Basic iframe usage:
                    content = `<iframe src="${f.content}" style="width:100%;height:100%;background:#fff;"></iframe>`;
                } else {
                    content = `<iframe src="${f.content}" style="width:100%;height:100%;background:#fff;"></iframe>`;
                }
                
                createWindow('view-'+index, f.name, content, 'fa-solid fa-file');
            }
            
            function clearFiles() {
                if(confirm('Delete all files?')) {
                    virtualFiles = [];
                    localStorage.removeItem('edu_files');
                    const w = document.getElementById('files');
                    if(w) {
                         w.querySelector('.file-grid').innerHTML = getFilesHTML();
                    }
                }
            }

            // --- SETTINGS APP ---
            function openSettingsApp() {
                const content = `
                <div class="settings-container">
                    <div class="setting-section">
                        <span class="setting-label">Accent Color</span>
                        <div class="color-options">
                            ${colors.map((c, i) => `
                                <div class="color-circle" style="background:${c.hex}" onclick="setAccentColor(${i})"></div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="setting-section">
                        <span class="setting-label">Wallpaper</span>
                         <div class="wallpaper-grid">
                            ${wallpapers.map((w, i) => `
                                <div class="wallpaper-option" style="background-image:url('${w.url}')" onclick="setWallpaper(${i})">
                                    <div class="wallpaper-name">${w.name}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="setting-section">
                        <span class="setting-label">System</span>
                        <button onclick="localStorage.clear();location.reload();" style="background:#FF5F57;color:white;border:none;padding:10px;border-radius:5px;cursor:pointer;">Reset All Data</button>
                    </div>
                </div>
                `;
                createWindow('settings', 'Settings', content, 'fa-solid fa-gear');
            }

            /* =========================================
               CONTEXT MENU
               ========================================= */
            const ctxMenu = document.getElementById('context-menu');
            
            document.addEventListener('contextmenu', (e) => {
                if(e.target.closest('.window')) return; // Allow default context in windows? Or custom?
                e.preventDefault();
                showContextMenu(e, 'desktop');
            });

            document.addEventListener('click', () => {
                ctxMenu.style.display = 'none';
            });

            function showContextMenu(e, type, data) {
                ctxMenu.style.display = 'block';
                ctxMenu.style.left = e.clientX + 'px';
                ctxMenu.style.top = e.clientY + 'px';
                
                let html = '';
                if(type === 'desktop') {
                    html = `
                        <div class="ctx-item" onclick="openSettingsApp()"><i class="fa-solid fa-gear"></i> Settings</div>
                        <div class="ctx-item" onclick="location.reload()"><i class="fa-solid fa-rotate-right"></i> Refresh</div>
                        <div class="ctx-item" onclick="togglePerformanceMode()"><i class="fa-solid fa-bolt"></i> Performance Mode</div>
                        <div class="ctx-item" onclick="openTerminal()"><i class="fa-solid fa-terminal"></i> Open Terminal</div>
                    `;
                } else if(type === 'app') {
                    html = `
                        <div class="ctx-item" onclick="createWindow('${data.id}', '${data.name}', '<iframe src=\\'${data.url}\\'></iframe>', '${data.icon}')"><i class="fa-solid fa-arrow-up-right-from-square"></i> Open</div>
                    `;
                    if(data.isCustom) {
                        html += `<div class="ctx-item" onclick="deleteCustomApp('${data.id}')" style="color:#FF5F57"><i class="fa-solid fa-trash"></i> Delete App</div>`;
                    }
                }
                
                ctxMenu.innerHTML = html;
            }

            /* =========================================
               MUSIC PLAYER & CLOCK
               ========================================= */
            function updateClock() {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            setInterval(updateClock, 1000);
            updateClock();

            // Music Player Logic
            const audio = document.getElementById('os-audio');
            let isPlaying = false;
            
            function toggleMusicPlayer() {
                const mp = document.getElementById('music-player');
                mp.classList.toggle('active');
                
                // Toggle the floating button visibility
                const floatBtn = document.getElementById('toggle-music');
                if(mp.classList.contains('active')) floatBtn.classList.add('hidden-ui');
                else floatBtn.classList.remove('hidden-ui');
            }

            function playLofiRadio() {
                // Lofi Girl stream URL usually requires YouTube embed, but here is a direct MP3 stream example (Lofi Girl Radio via standard stream url if available, otherwise a placeholder)
                // Using a reliable radio stream (Star Wars Lofi or similar free stream)
                const streamUrl = "https://streams.ilovemusic.de/ilovemusic16.mp3"; 
                playDirect(streamUrl);
                document.getElementById('now-playing-text').innerText = "Radio: Chill Lofi Beats";
            }

            function playDirect(url) {
                if(!url) return;
                
                // Check if it's a YouTube link -> use iframe embed
                if(url.includes('youtube.com') || url.includes('youtu.be')) {
                    // Extract ID
                    let vidId = '';
                    if(url.includes('v=')) vidId = url.split('v=')[1].split('&')[0];
                    else vidId = url.split('/').pop();
                    
                    document.getElementById('classic-player-ui').style.display = 'none';
                    const cont = document.getElementById('embed-container');
                    cont.style.display = 'block';
                    cont.innerHTML = `<iframe width="100%" height="200" src="https://www.youtube.com/embed/${vidId}?autoplay=1" frameborder="0" allow="autoplay; encrypted-media"></iframe>`;
                    
                    audio.pause();
                    return;
                }

                // Standard Audio
                document.getElementById('embed-container').style.display = 'none';
                document.getElementById('classic-player-ui').style.display = 'block';
                
                audio.src = url;
                audio.play();
                isPlaying = true;
                updatePlayBtn();
            }

            function togglePlayState() {
                if(audio.paused) {
                    audio.play();
                    isPlaying = true;
                } else {
                    audio.pause();
                    isPlaying = false;
                }
                updatePlayBtn();
            }

            function updatePlayBtn() {
                const btn = document.getElementById('play-pause-btn');
                btn.innerHTML = isPlaying ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play"></i>';
            }

            function setVolume(val) {
                audio.volume = val;
            }

            function skip(sec) {
                audio.currentTime += sec;
            }

            function updateProgress() {
                const bar = document.getElementById('progress-fill');
                const curr = document.getElementById('curr-time');
                const dur = document.getElementById('dur-time');
                
                if(isNaN(audio.duration)) return;
                
                const pct = (audio.currentTime / audio.duration) * 100;
                bar.style.width = pct + '%';
                
                curr.innerText = formatTime(audio.currentTime);
                dur.innerText = formatTime(audio.duration);
            }

            function seekAudio(e) {
                const bar = document.getElementById('progress-bar');
                const clickX = e.offsetX;
                const width = bar.clientWidth;
                const duration = audio.duration;
                
                if(!isNaN(duration)) {
                    audio.currentTime = (clickX / width) * duration;
                }
            }

            function formatTime(s) {
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m}:${sec < 10 ? '0' : ''}${sec}`;
            }

            function searchMusic() {
                const query = document.getElementById('music-search-input').value;
                if(!query) return;
                
                // Using iTunes Search API (no CORS proxy usually needed for simple GET)
                fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&limit=5`)
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('music-results');
                    list.innerHTML = '';
                    
                    data.results.forEach(track => {
                        const div = document.createElement('div');
                        div.className = 'song-result';
                        div.innerHTML = `
                            <img src="${track.artworkUrl60}" class="song-img">
                            <div style="flex:1;overflow:hidden;">
                                <div class="song-name">${track.trackName}</div>
                                <div class="song-artist">${track.artistName}</div>
                            </div>
                        `;
                        div.onclick = () => {
                            playDirect(track.previewUrl);
                            document.getElementById('now-playing-text').innerText = `${track.trackName} - ${track.artistName}`;
                        };
                        list.appendChild(div);
                    });
                })
                .catch(err => alert("Music search failed."));
            }

            /* =========================================
               CUSTOM APPS MODAL
               ========================================= */
            function openModal() {
                document.getElementById('custom-app-modal').style.display = 'flex';
            }
            function closeModal() {
                document.getElementById('custom-app-modal').style.display = 'none';
                document.getElementById('app-name-input').value = '';
                document.getElementById('app-url-input').value = '';
            }
            function saveCustomApp() {
                const name = document.getElementById('app-name-input').value;
                let url = document.getElementById('app-url-input').value;
                if (!name || !url) return alert("Please fill in all fields.");
                if (!url.startsWith('http') && !url.startsWith('/') && !url.startsWith('./')) url = 'https://' + url;
                
                apps.push({ id: 'custom-' + Date.now(), name: name, icon: 'fa-solid fa-link', url: url, isCustom: true });
                localStorage.setItem('customApps', JSON.stringify(apps.filter(a => a.isCustom)));
                renderIcons();
                closeModal();
            }

            function deleteCustomApp(id) {
                if(!confirm("Are you sure you want to delete this app?")) return;

                // Remove from the running apps list
                apps = apps.filter(a => a.id !== id);

                // Update LocalStorage
                const customAppsOnly = apps.filter(a => a.isCustom);
                localStorage.setItem('customApps', JSON.stringify(customAppsOnly));

                // Re-render desktop and close menu
                renderIcons();
                document.getElementById('context-menu').style.display = 'none';
            }

            /* =========================================
               INIT
               ========================================= */
            renderIcons();

		</script>
	</div>
</body>

</html>
