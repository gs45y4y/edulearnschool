<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>EdulearnOS - Ultimate</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&family=Fira+Code:wght@400;700&display=swap"
		rel="stylesheet" />
	<style>
		:root {
			--accent-color: #7dd4ff;
			--glass-border: rgba(125, 212, 255, 0.3);
			--glass-bg: rgba(255, 255, 255, 0.08);
			--dock-bg: rgba(10, 20, 30, 0.4);
			--win-bg: rgba(5, 8, 12, 0.96);
			--text: #ffffff;
			--term-bg: #1a1b26;
			--term-green: #9ece6a;
			--term-blue: #7aa2f7;
			--term-red: #f7768e;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			user-select: none;
		}

		body {
			background: #050505 url('https://cdn2.steamgriddb.com/hero/06d655f3f1b3146fe366201ff7431d64.png') no-repeat center center fixed;
			background-size: cover;
			color: var(--text);
			font-family: 'Inter', sans-serif;
			height: 100vh;
			overflow: hidden;
			transition: background-image 0.5s ease-in-out;
		}

		/* --- Branding Watermark --- */
		#os-brand {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 10vw;
			font-weight: 900;
			color: rgba(255, 255, 255, 0.95);
			text-shadow: 0 0 20px rgba(0, 0, 0, 0.5), 0 0 40px var(--accent-color);
			z-index: 0;
			pointer-events: none;
			text-transform: uppercase;
			letter-spacing: -0.02em;
			white-space: nowrap;
			transition: text-shadow 0.5s ease;
		}

		#lifeblood-canvas {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 1;
			pointer-events: none;
		}

		#snap-preview {
			position: fixed;
			background: rgba(125, 212, 255, 0.15);
			border: 2px dashed var(--accent-color);
			border-radius: 20px;
			z-index: 5;
			display: none;
			pointer-events: none;
			transition: all 0.2s cubic-bezier(0.2, 0, 0.2, 1);
		}

		#desktop {
			position: relative;
			z-index: 2;
			width: 100%;
			height: 100vh;
			padding: 20px;
		}

		/* --- Desktop Icons --- */
		.icon {
			position: absolute;
			display: flex;
			flex-direction: column;
			align-items: center;
			text-align: center;
			cursor: grab;
			width: 90px;
			transition: transform 0.2s;
		}

		.icon:active {
			cursor: grabbing;
		}

		.icon:hover {
			transform: scale(1.1);
			z-index: 100;
		}

		.icon-visual {
			width: 60px;
			height: 60px;
			margin-bottom: 8px;
			background: var(--glass-bg);
			border: 1px solid var(--glass-border);
			border-radius: 16px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 26px;
			backdrop-filter: blur(15px);
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
			color: var(--accent-color);
			transition: color 0.3s, border-color 0.3s;
		}

		.icon span {
			font-size: 11px;
			text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
			background: rgba(0, 0, 0, 0.3);
			padding: 2px 6px;
			border-radius: 8px;
		}

		/* --- Window UI --- */
		.window {
			position: absolute;
			width: 900px;
			height: calc(100vh - 140px);
			background: var(--win-bg);
			backdrop-filter: blur(40px);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			display: flex;
			flex-direction: column;
			box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
			z-index: 10;
			overflow: hidden;
			transition: width 0.3s, height 0.3s, transform 0.3s, border-color 0.3s;
		}

		.window.maximized {
			width: 100% !important;
			height: 100% !important;
			top: 0 !important;
			left: 0 !important;
			border-radius: 0;
		}

		.window.snap-left {
			width: 50% !important;
			height: 100% !important;
			top: 0 !important;
			left: 0 !important;
			border-radius: 0;
		}

		.window.snap-right {
			width: 50% !important;
			height: 100% !important;
			top: 0 !important;
			left: 50% !important;
			border-radius: 0;
		}

		.window.minimized {
			transform: scale(0.1) translateY(1000px);
			opacity: 0;
			pointer-events: none;
		}

		.window-header {
			padding: 12px 18px;
			background: rgba(255, 255, 255, 0.05);
			display: flex;
			justify-content: space-between;
			align-items: center;
			cursor: default;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		}

		.win-title {
			font-size: 13px;
			color: var(--accent-color);
			flex-grow: 1;
			text-align: center;
			pointer-events: none;
		}

		.win-controls {
			display: flex;
			gap: 8px;
		}

		.control {
			width: 12px;
			height: 12px;
			border-radius: 50%;
			cursor: pointer;
			transition: 0.2s;
		}

		.control:hover {
			filter: brightness(1.2);
			transform: scale(1.1);
		}

		.close {
			background: #FF5F57;
		}

		.min {
			background: #FFBD2E;
		}

		.max {
			background: #28C840;
		}

		.window-body {
			flex: 1;
			background: #fff;
			position: relative;
			overflow: auto;
		}

		.window-body iframe {
			width: 100%;
			height: 100%;
			border: none;
		}

		.drag-overlay {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			display: none;
			z-index: 5;
		}

		/* --- Apps Specific Styles --- */
		.file-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
			gap: 15px;
			padding: 20px;
			min-height: 100%;
		}

		.file-item {
			display: flex;
			flex-direction: column;
			align-items: center;
			text-align: center;
			cursor: pointer;
			padding: 10px;
			border-radius: 10px;
			transition: 0.2s;
			color: #333;
		}

		.file-item:hover {
			background: rgba(0, 0, 0, 0.05);
		}

		.file-icon {
			font-size: 40px;
			margin-bottom: 8px;
			color: var(--accent-color);
		}

		.file-name {
			font-size: 12px;
			word-break: break-all;
			color: #333;
		}

		/* --- TERMINAL --- */
		.terminal-body {
			background-color: var(--term-bg);
			color: #c0caf5;
			font-family: 'Courier New', Courier, monospace !important;
			padding: 20px;
			height: 100%;
			overflow-y: auto;
			font-size: 14px;
			text-align: left;
		}

		.term-line {
			margin-bottom: 5px;
			white-space: pre-wrap;
			font-family: 'Courier New', Courier, monospace !important;
		}

		.term-prompt {
			color: var(--term-blue);
			font-weight: bold;
			margin-right: 8px;
		}

		.term-input-line {
			display: flex;
			align-items: center;
		}

		.term-input {
			background: transparent;
			border: none;
			color: #fff;
			font-family: 'Courier New', Courier, monospace !important;
			font-size: 14px;
			outline: none;
			flex: 1;
			caret-color: var(--term-green);
		}

		.fetch-grid {
			display: flex;
			gap: 25px;
			align-items: center;
			padding: 10px;
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 10px;
			margin-bottom: 15px;
			background: rgba(255, 255, 255, 0.02);
		}

		.os-logo-icon {
			font-size: 80px;
			color: var(--accent-color);
			filter: drop-shadow(0 0 10px rgba(125, 212, 255, 0.5));
		}

		/* --- Dock & Trigger --- */
		#taskbar {
			position: fixed;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			height: 70px;
			background: var(--dock-bg);
			backdrop-filter: blur(35px);
			border: 1px solid var(--glass-border);
			border-radius: 22px;
			display: flex;
			align-items: center;
			padding: 0 25px;
			z-index: 9999;
			gap: 20px;
			transition: transform 0.4s cubic-bezier(0.2, 0, 0.2, 1), opacity 0.4s;
		}

		#taskbar.hidden {
			transform: translate(-50%, 150%);
			opacity: 0;
			pointer-events: none;
		}

		#dock-trigger {
			position: fixed;
			bottom: 0;
			left: 0;
			width: 100%;
			height: 15px;
			z-index: 9998;
		}

		.shield-btn {
			display: flex;
			align-items: center;
			gap: 12px;
			background: rgba(255, 255, 255, 0.1);
			padding: 8px 18px;
			border-radius: 15px;
			cursor: pointer;
			border: 1px solid var(--glass-border);
			color: var(--accent-color);
			transition: 0.2s;
		}

		.shield-btn:hover {
			background: rgba(255, 255, 255, 0.2);
			transform: scale(1.05);
		}

		.add-btn {
			width: 45px;
			height: 45px;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.1);
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			border: 1px solid var(--glass-border);
			color: var(--accent-color);
			font-size: 18px;
			transition: 0.2s;
		}

		.add-btn:hover {
			background: rgba(255, 255, 255, 0.2);
			transform: scale(1.1) rotate(90deg);
		}

		/* PERFORMANCE MODE ACTIVE STATE */
		.perf-active .shield-btn i {
			color: #ffd700 !important;
		}

		/* Disable effects when in performance mode */
		body.perf-mode .window,
		body.perf-mode #taskbar,
		body.perf-mode .icon-visual,
		body.perf-mode #music-player,
		body.perf-mode #context-menu,
		body.perf-mode .shield-btn,
		body.perf-mode .add-btn {
			backdrop-filter: none !important;
			box-shadow: none !important;
			transition: none !important;
		}

		body.perf-mode .window {
			background: rgba(10, 15, 25, 1);
			border: 1px solid #333;
		}

		body.perf-mode #taskbar {
			background: rgba(10, 20, 30, 0.95);
			border: 1px solid #444;
		}

		body.perf-mode #music-player {
			background: #111;
		}

		#clock {
			font-size: 16px;
			font-weight: 500;
			color: var(--accent-color);
			text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
			border-left: 1px solid var(--glass-border);
			padding-left: 20px;
		}

		/* --- Music Player Sidebar --- */
		#music-player {
			position: fixed;
			top: 100px;
			right: 20px;
			width: 320px;
			background: rgba(10, 15, 25, 0.9);
			backdrop-filter: blur(25px);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			padding: 20px;
			z-index: 8000;
			color: #fff;
			transition: transform 0.3s ease;
			transform: translateX(360px);
			display: flex;
			flex-direction: column;
			max-height: 80vh;
		}

		#music-player.active {
			transform: translateX(0);
		}

		.music-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
		}

		.music-title {
			font-weight: 700;
			color: var(--accent-color);
		}

		.music-close {
			cursor: pointer;
			color: #FF5F57;
		}

		.search-container {
			display: flex;
			gap: 5px;
			margin-bottom: 15px;
		}

		.music-search {
			flex: 1;
			background: rgba(255, 255, 255, 0.1);
			border: 1px solid rgba(255, 255, 255, 0.2);
			padding: 8px 12px;
			border-radius: 10px;
			color: #fff;
			outline: none;
			font-size: 12px;
		}

		.search-btn {
			background: var(--accent-color);
			border: none;
			border-radius: 8px;
			width: 35px;
			cursor: pointer;
			color: #000;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.radio-btn {
			width: 100%;
			background: rgba(255, 255, 255, 0.1);
			border: 1px solid rgba(255, 255, 255, 0.2);
			color: #fff;
			padding: 8px;
			border-radius: 10px;
			margin-bottom: 15px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			font-size: 12px;
			transition: 0.2s;
		}

		.radio-btn:hover {
			background: rgba(255, 255, 255, 0.2);
			border-color: var(--accent-color);
		}

		.radio-btn i {
			color: #f7768e;
		}

		.results-list {
			flex: 1;
			overflow-y: auto;
			margin-bottom: 15px;
			display: flex;
			flex-direction: column;
			gap: 8px;
			max-height: 150px;
			padding-right: 5px;
		}

		.results-list::-webkit-scrollbar {
			width: 4px;
		}

		.results-list::-webkit-scrollbar-thumb {
			background: var(--glass-border);
			border-radius: 4px;
		}

		.song-result {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 8px;
			background: rgba(255, 255, 255, 0.05);
			border-radius: 8px;
			cursor: pointer;
			transition: 0.2s;
		}

		.song-result:hover {
			background: rgba(255, 255, 255, 0.15);
		}

		.song-img {
			width: 35px;
			height: 35px;
			border-radius: 4px;
			background: #333;
			object-fit: cover;
		}

		.song-info {
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}

		.song-name {
			font-size: 12px;
			font-weight: bold;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.song-artist {
			font-size: 10px;
			color: #aaa;
		}

		.visualizer {
			width: 100%;
			height: 50px;
			display: flex;
			align-items: flex-end;
			justify-content: center;
			gap: 3px;
			margin-bottom: 10px;
			opacity: 0.5;
		}

		.bar {
			width: 5px;
			background: var(--accent-color);
			height: 10px;
			animation: bounce 1s infinite ease-in-out;
		}

		.bar:nth-child(2) {
			animation-delay: 0.1s;
		}

		.bar:nth-child(3) {
			animation-delay: 0.2s;
		}

		.bar:nth-child(4) {
			animation-delay: 0.3s;
		}

		.bar:nth-child(5) {
			animation-delay: 0.4s;
		}

		@keyframes bounce {

			0%,
			100% {
				height: 10px;
			}

			50% {
				height: 40px;
			}
		}

		/* --- Custom Player Controls --- */
		.custom-player-ui {
			background: rgba(255, 255, 255, 0.05);
			padding: 15px;
			border-radius: 12px;
			display: flex;
			flex-direction: column;
			gap: 10px;
			border: 1px solid rgba(255, 255, 255, 0.1);
		}

		.progress-area {
			display: flex;
			align-items: center;
			gap: 10px;
			font-size: 10px;
			color: #aaa;
		}

		.progress-bar {
			flex: 1;
			height: 4px;
			background: rgba(255, 255, 255, 0.2);
			border-radius: 2px;
			cursor: pointer;
			position: relative;
		}

		.progress-fill {
			width: 0%;
			height: 100%;
			background: var(--accent-color);
			border-radius: 2px;
		}

		.player-buttons {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 20px;
		}

		.p-btn {
			background: none;
			border: none;
			color: #fff;
			cursor: pointer;
			font-size: 16px;
			transition: 0.2s;
		}

		.p-btn:hover {
			color: var(--accent-color);
			transform: scale(1.1);
		}

		.play-toggle {
			width: 35px;
			height: 35px;
			border-radius: 50%;
			background: var(--accent-color);
			color: #000;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 14px;
		}

		.volume-area {
			display: flex;
			align-items: center;
			gap: 8px;
			justify-content: center;
			margin-top: 5px;
		}

		.vol-slider {
			-webkit-appearance: none;
			width: 80px;
			height: 3px;
			background: rgba(255, 255, 255, 0.2);
			border-radius: 2px;
			outline: none;
		}

		.vol-slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			width: 10px;
			height: 10px;
			border-radius: 50%;
			background: var(--accent-color);
			cursor: pointer;
		}

		.now-playing {
			font-size: 11px;
			color: var(--accent-color);
			text-align: center;
			margin-bottom: 5px;
			height: 15px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}
        
        #embed-container {
            width: 100%;
            display: none;
            margin-bottom: 10px;
            border-radius: 12px;
            overflow: hidden;
        }

		#toggle-music {
			position: fixed;
			bottom: 100px;
			right: 20px;
			width: 50px;
			height: 50px;
			background: var(--dock-bg);
			border: 1px solid var(--glass-border);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			color: var(--accent-color);
			z-index: 7000;
			cursor: pointer;
			backdrop-filter: blur(10px);
			transition: 0.2s;
		}

		#toggle-music:hover {
			transform: scale(1.1);
		}

		/* --- Context Menu & Popups --- */
		#context-menu {
			position: fixed;
			z-index: 20000;
			display: none;
			background: rgba(15, 20, 30, 0.95);
			backdrop-filter: blur(10px);
			border: 1px solid var(--glass-border);
			border-radius: 10px;
			padding: 5px;
			min-width: 150px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
		}

		.ctx-item {
			padding: 10px 15px;
			color: #fff;
			font-size: 13px;
			cursor: pointer;
			border-radius: 6px;
			display: flex;
			align-items: center;
			gap: 10px;
			transition: 0.2s;
		}

		.ctx-item:hover {
			background: rgba(255, 255, 255, 0.1);
		}

		.ctx-delete i {
			color: #FF5F57;
		}

		.ctx-import i {
			color: #28C840;
		}

		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.75);
			backdrop-filter: blur(8px);
			z-index: 10000;
			display: none;
			align-items: center;
			justify-content: center;
		}

		.modal-content {
			width: 400px;
			background: #0f151c;
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			padding: 30px;
			display: flex;
			flex-direction: column;
			gap: 15px;
			box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
		}

		.modal-content h3 {
			color: var(--accent-color);
			margin-bottom: 5px;
		}

		.modal-content input {
			background: rgba(255, 255, 255, 0.1);
			border: 1px solid rgba(255, 255, 255, 0.2);
			padding: 12px;
			border-radius: 10px;
			color: #fff;
			outline: none;
			font-family: inherit;
		}

		.modal-content input:focus {
			border-color: var(--accent-color);
		}

		.modal-btns {
			display: flex;
			gap: 10px;
			justify-content: flex-end;
			margin-top: 10px;
		}

		.modal-btn {
			padding: 8px 16px;
			border-radius: 8px;
			border: none;
			cursor: pointer;
			font-weight: 600;
		}

		.btn-cancel {
			background: rgba(255, 255, 255, 0.1);
			color: #fff;
		}

		.btn-save {
			background: var(--accent-color);
			color: #000;
		}
	</style>
</head>

<body>

	<div id="os-brand">EdulearnOS</div>
	<canvas id="lifeblood-canvas"></canvas>
	<div id="snap-preview"></div>
	<div id="dock-trigger"></div>
	<div id="desktop"></div>

	<input type="file" id="file-uploader" style="display: none;" onchange="processFileImport(this)">
	<div id="context-menu"></div>

	<div id="toggle-music" onclick="toggleMusicPlayer()"><i class="fa-solid fa-music"></i></div>
	<div id="music-player">
		<div class="music-header">
			<span class="music-title">SonicBar <span style="font-size:9px;opacity:0.6;">(SC/Tidal Support)</span></span>
			<i class="fa-solid fa-times music-close" onclick="toggleMusicPlayer()"></i>
		</div>

        <div style="margin-bottom:5px; font-size:10px; color:#aaa;">Load SoundCloud/Tidal/MP3 URL:</div>
		<div class="search-container">
			<input type="text" class="music-search" id="direct-url-input" placeholder="Paste SoundCloud/Tidal/MP3 Link..." onchange="playDirect(this.value)">
			<button class="search-btn" onclick="playDirect(document.getElementById('direct-url-input').value)"><i class="fa-solid fa-play"></i></button>
		</div>

        <div id="embed-container"></div>

        <div id="classic-player-ui">
            <div class="radio-btn" onclick="playLofiRadio()">
                <i class="fa-solid fa-radio"></i> Start Lofi Radio (Unlimited)
            </div>

            <div class="search-container">
                <input type="text" class="music-search" id="music-search-input" placeholder="Search iTunes Previews..." onkeydown="if(event.key==='Enter') searchMusic()">
                <button class="search-btn" onclick="searchMusic()"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>

            <div class="results-list" id="music-results">
                <div style="text-align:center; color:#666; font-size:11px; padding:10px;">
                    Search finds 30s previews.<br>Use the top box for full SoundCloud links.
                </div>
            </div>

            <div class="now-playing" id="now-playing-text">Not Playing</div>

            <div class="visualizer">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>

            <div class="custom-player-ui">
                <div class="progress-area">
                    <span id="curr-time">0:00</span>
                    <div class="progress-bar" id="progress-bar" onclick="seekAudio(event)">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <span id="dur-time">0:00</span>
                </div>

                <div class="player-buttons">
                    <button class="p-btn" onclick="skip(-5)"><i class="fa-solid fa-backward"></i></button>
                    <button class="p-btn play-toggle" id="play-pause-btn" onclick="togglePlayState()">
                    <i class="fa-solid fa-play"></i>
                </button>
                    <button class="p-btn" onclick="skip(5)"><i class="fa-solid fa-forward"></i></button>
                </div>

                <div class="volume-area">
                    <i class="fa-solid fa-volume-low" style="font-size:12px; color:#aaa;"></i>
                    <input type="range" class="vol-slider" min="0" max="1" step="0.05" value="0.8" oninput="setVolume(this.value)">
                </div>
            </div>
        </div>
        
		<audio id="os-audio" style="display:none;" crossorigin="anonymous" ontimeupdate="updateProgress()"
			onended="onAudioEnded()"></audio>

  </div>

				<div id="custom-app-modal" class="modal-overlay">
					<div class="modal-content">
						<h3>Create New App</h3>
						<input type="text" id="app-name-input" placeholder="App Name (e.g., My Game)">
						<input type="text" id="app-url-input" placeholder="URL (e.g., https://example.com)">
						<div class="modal-btns">
							<button class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
							<button class="modal-btn btn-save" onclick="saveCustomApp()">Create App</button>
						</div>
					</div>
				</div>

				<div id="taskbar">
					<div class="shield-btn" onclick="openCloakMenu()">
						<i class="fa-solid fa-shield-halved"></i> <span>Cloak</span>
					</div>
					<div class="shield-btn" onclick="cycleTheme()">
						<i class="fa-solid fa-palette"></i> <span id="theme-name">Theme</span>
					</div>

					<div class="shield-btn" id="perf-btn" onclick="togglePerformanceMode()"
						title="Toggle Performance Mode">
						<i class="fa-solid fa-bolt"></i> <span>Boost</span>
					</div>

					<div class="add-btn" onclick="openModal()" title="Add Custom App">
						<i class="fa-solid fa-plus"></i>
					</div>
					<div id="clock">12:00 PM</div>
				</div>

				<script>
	// --- On Load Alerts ---
    window.addEventListener('load', () => {
        // Zoom Recommendation
        if (!localStorage.getItem('edu_welcome_shown')) {
            alert("Welcome to EdulearnOS.\n\nWe recommend setting your browser zoom to 67% for the best full-desktop experience.");
            localStorage.setItem('edu_welcome_shown', 'true');
        }

        // Performance Check (Default Alert)
        setTimeout(() => {
            const userWantsPerf = confirm("System Performance Check:\n\nEnable 'Boost Mode' to reduce animations and improve speed?\n(Recommended for school Chromebooks)");
            if (userWantsPerf) {
                togglePerformanceMode(true);
            }
        }, 500);
    });

    // --- Performance Mode Logic ---
    let isPerfMode = false;
    let animId = null; 

    function togglePerformanceMode(silent = false) {
        const btn = document.getElementById('perf-btn');
        if (!isPerfMode) {
            isPerfMode = true;
            document.body.classList.add('perf-mode');
            btn.classList.add('perf-active');
            btn.querySelector('span').innerText = "Normal";
            cancelAnimationFrame(animId);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        } else {
            isPerfMode = false;
            document.body.classList.remove('perf-mode');
            btn.classList.remove('perf-active');
            btn.querySelector('span').innerText = "Boost";
            anim();
        }
    }

    // --- Theme Logic ---
    const themes = [
        { name: "Lifeblood", primary: "#7dd4ff", rgb: "125, 212, 255", bg: "https://cdn2.steamgriddb.com/hero/06d655f3f1b3146fe366201ff7431d64.png", border: "rgba(125, 212, 255, 0.3)" },
        { name: "Voidheart", primary: "#d1d1d1", rgb: "200, 200, 200", bg: "https://cdn2.steamgriddb.com/hero_thumb/781ac61bc87f26f5ade393be143d9ace.jpg", border: "rgba(180, 180, 180, 0.3)" },
        { name: "Grimm", primary: "#ff4d4d", rgb: "255, 50, 50", bg: "https://wallpapercave.com/wp/wp4265395.jpg", border: "rgba(255, 50, 50, 0.4)" }
    ];
    let currentThemeIdx = 0;
    let currentParticleRGB = themes[0].rgb;
    document.getElementById('theme-name').innerText = themes[0].name;

    function cycleTheme() {
        currentThemeIdx = (currentThemeIdx + 1) % themes.length;
        const t = themes[currentThemeIdx];
        const root = document.documentElement;
        root.style.setProperty('--accent-color', t.primary);
        root.style.setProperty('--glass-border', t.border);
        document.body.style.backgroundImage = `url('${t.bg}')`;
        currentParticleRGB = t.rgb;
        document.getElementById('theme-name').innerText = t.name;
    }

    // --- Particles ---
    const canvas = document.getElementById('lifeblood-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    window.addEventListener('resize', resize); resize();

    class P {
        constructor() { this.reset(); }
        reset() {
            this.x = Math.random() * canvas.width; this.y = canvas.height + 20;
            this.s = Math.random() * 2 + 1; this.vy = Math.random() * -0.7 - 0.2;
            this.o = Math.random() * 0.5 + 0.1;
        }
        update() { this.y += this.vy; if (this.y < -10) this.reset(); }
        draw() { ctx.fillStyle = `rgba(${currentParticleRGB}, ${this.o})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.s, 0, Math.PI*2); ctx.fill(); }
    }
    for(let i=0; i<50; i++) particles.push(new P());
    
    function anim() { 
        if(isPerfMode) return; 
        ctx.clearRect(0,0,canvas.width,canvas.height); 
        particles.forEach(p=>{p.update();p.draw();}); 
        animId = requestAnimationFrame(anim); 
    }
    anim();

    // --- OS Apps & Desktop ---
    let apps = [
        { id: 'sc', name: 'Scramjet', icon: 'fa-solid fa-rocket', url: atob('Li9zY2llbmNlLw==') },
        { id: 'sp', name: 'UV Proxy (Nonexistant)', icon: 'fa-solid fa-ghost', url: atob('Li9zcGFuaXNoL2FjdGl2ZS9pbmRleC5odG1s') },
        { id: 'gn', name: 'GN Math', icon: 'fa-solid fa-calculator', url: atob('Li9tYXRoL2duLW1hdGguaHRtbA==') },
        { id: 'term', name: 'Terminal', icon: 'fa-solid fa-terminal', isSystem: true },
        { id: 'dm', name: 'Dosmes AI', icon: 'fa-solid fa-chart-line', url: atob('aHR0cHM6Ly9kZXNtb3MubGF0') },
        { id: 'gc', name: 'Graphing', icon: 'fa-solid fa-chart-simple', url: atob('Li9ncmFwaGNhbGMuaHRtbA==') },
        { id: 'fs', name: 'Files', icon: 'fa-solid fa-folder-open', isSystem: true },
        { id: 'd2', name: 'Dosmes Mirror', icon: 'fa-solid fa-compass', url: atob('aHR0cHM6Ly9kb3NtZXMuZ2xvYmFsLnNzbC5mYXN0bHkubmV0') },
        { id: 'bw', name: 'Burning H20', icon: 'fa-solid fa-fire-burner', url: atob('Li9id3MvaW5kZXguaHRtbA==') },
        { id: 'rb', name: 'Reactboard (WIP)', icon: 'fa-solid fa-bolt', url: atob('Li9yZWFjdGlvbmJvYXJkLmh0bWw=') }
    ];

    const storedApps = localStorage.getItem('customApps');
    if (storedApps) apps = apps.concat(JSON.parse(storedApps));

    let virtualFiles = JSON.parse(localStorage.getItem('edu_files') || '[]');
    const _0xKey = atob('amF5ZXNobG92ZXNsaXZpZW5uZQ==');
    const desktop = document.getElementById('desktop');
    let zIndexCounter = 100;
    const openWindows = {};
    let currentRightClickedAppId = null;

    function renderIcons() {
        desktop.innerHTML = '';
        const startX = 30; const startY = 30; 
        const gridX = 100; const gridY = 100;
        const maxCols = Math.floor((window.innerWidth - 60) / gridX);
        
        apps.forEach((app, index) => {
            const div = document.createElement('div');
            div.className = 'icon';
            const col = index % maxCols;
            const row = Math.floor(index / maxCols);
            div.style.left = (startX + (col * gridX)) + 'px';
            div.style.top = (startY + (row * gridY)) + 'px';
            
            const iconClass = app.icon.startsWith('fa') ? app.icon : 'fa-solid fa-globe';
            div.innerHTML = `<div class="icon-visual"><i class="${iconClass}"></i></div><span>${app.name}</span>`;
            makeIconDraggable(div, () => { openWindows[app.id] ? toggleMin(app.id) : launch(app); });
            div.oncontextmenu = (e) => {
                if (app.isCustom) { e.preventDefault(); showContextMenu(e.clientX, e.clientY, 'desktop-icon', app); }
            };
            desktop.appendChild(div);
        });
    }
    window.addEventListener('resize', renderIcons); 
    renderIcons();

    // --- Dock Hover ---
    const dockTrigger = document.getElementById('dock-trigger');
    const taskbar = document.getElementById('taskbar');
    dockTrigger.addEventListener('mouseenter', () => taskbar.classList.remove('hidden'));
    taskbar.addEventListener('mouseleave', () => {
        const hasVisibleMax = Object.values(openWindows).some(w => w.classList.contains('maximized') && !w.classList.contains('minimized'));
        if (hasVisibleMax) taskbar.classList.add('hidden');
    });

    // --- Music Player Logic ---
    const audioPlayer = document.getElementById('os-audio');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const progressFill = document.getElementById('progress-fill');
    const embedContainer = document.getElementById('embed-container');
    const classicUI = document.getElementById('classic-player-ui');
    
    function toggleMusicPlayer() { document.getElementById('music-player').classList.toggle('active'); }
    
    function playLofiRadio() {
        playDirect("https://stream.zeno.fm/99p68g7yfq8uv");
    }

    // UPDATED PLAY FUNCTION: Handles SoundCloud/Tidal Embeds
    function playDirect(url) {
        if(!url) return;
        
        // Check for SoundCloud URL
        if(url.includes('soundcloud.com')) {
            loadEmbedPlayer(url, 'sc');
            return;
        }
        
        // Check for Tidal URL
        if(url.includes('tidal.com')) {
            loadEmbedPlayer(url, 'tidal');
            return;
        }

        // Default MP3/Stream handling
        resetToClassicUI();
        audioPlayer.src = url; 
        audioPlayer.play();
        document.getElementById('now-playing-text').innerText = url.includes('zeno') ? "Playing: Live Radio" : "Playing: Custom URL";
        playPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
    }

    function loadEmbedPlayer(url, type) {
        audioPlayer.pause(); // Stop internal audio
        classicUI.style.display = 'none';
        embedContainer.style.display = 'block';
        
        let embedHTML = '';
        
        if (type === 'sc') {
            // SoundCloud Widget API
            embedHTML = `<iframe width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay" 
            src="https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%237dd4ff&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe>`;
        } else if (type === 'tidal') {
            // Basic Tidal Embed (May require specific ID extraction depending on URL format)
            // Example: https://tidal.com/browse/track/12345 -> https://embed.tidal.com/tracks/12345
            let tidalId = url.split('/').pop();
            let typeSeg = url.includes('album') ? 'albums' : 'tracks'; // Simple guess
            embedHTML = `<div style="position:relative;padding-bottom:100%;height:0;overflow:hidden;max-width:100%;"><iframe src="https://embed.tidal.com/${typeSeg}/${tidalId}?layout=gridify" frameborder="0" allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe></div>`;
        }
        
        embedContainer.innerHTML = embedHTML;
    }

    function resetToClassicUI() {
        embedContainer.innerHTML = '';
        embedContainer.style.display = 'none';
        classicUI.style.display = 'block';
    }

    function togglePlayState() {
        if(audioPlayer.paused) {
            audioPlayer.play();
            playPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
        } else {
            audioPlayer.pause();
            playPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
        }
    }
    
    function skip(sec) { audioPlayer.currentTime += sec; }
    function setVolume(val) { audioPlayer.volume = val; }
    
    function updateProgress() {
        if(isNaN(audioPlayer.duration) || !isFinite(audioPlayer.duration)) {
            progressFill.style.width = '100%';
            document.getElementById('curr-time').innerText = "LIVE";
            document.getElementById('dur-time').innerText = "âˆž";
            return;
        }
        const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressFill.style.width = percent + '%';
        document.getElementById('curr-time').innerText = formatTime(audioPlayer.currentTime);
        document.getElementById('dur-time').innerText = formatTime(audioPlayer.duration);
    }
    
    function seekAudio(e) {
        if(!isFinite(audioPlayer.duration)) return;
        const bar = document.getElementById('progress-bar');
        const percent = e.offsetX / bar.clientWidth;
        audioPlayer.currentTime = percent * audioPlayer.duration;
    }
    
    function formatTime(s) {
        const min = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return min + ':' + (sec < 10 ? '0' + sec : sec);
    }
    
    function onAudioEnded() {
        playPauseBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
        progressFill.style.width = '0%';
    }

    async function searchMusic() {
        // Ensure we are in classic mode
        resetToClassicUI();
        const query = document.getElementById('music-search-input').value;
        if(!query) return;
        const list = document.getElementById('music-results');
        list.innerHTML = '<div style="text-align:center;font-size:12px;">Searching iTunes (Previews)...</div>';

        try {
            const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&limit=10`);
            const data = await res.json();
            list.innerHTML = '';
            if(data.resultCount === 0) {
                list.innerHTML = '<div style="text-align:center;font-size:12px;">No results found.</div>';
                return;
            }
            data.results.forEach(track => {
                const item = document.createElement('div');
                item.className = 'song-result';
                item.innerHTML = `
                    <img src="${track.artworkUrl60}" class="song-img">
                    <div class="song-info">
                        <div class="song-name">${track.trackName}</div>
                        <div class="song-artist">${track.artistName}</div>
                    </div>
                `;
                item.onclick = () => {
                    audioPlayer.src = track.previewUrl;
                    audioPlayer.play();
                    document.getElementById('now-playing-text').innerText = `Preview: ${track.trackName}`;
                    playPauseBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                };
                list.appendChild(item);
            });
        } catch(err) {
            list.innerHTML = '<div style="text-align:center;font-size:12px;color:#FF5F57">Error fetching songs.</div>';
        }
    }

    // --- Context Menu ---
    const ctxMenu = document.getElementById('context-menu');
    document.addEventListener('click', () => ctxMenu.style.display = 'none'); 

    function showContextMenu(x, y, type, data) {
        ctxMenu.innerHTML = '';
        let hasItems = false;
        if (type === 'desktop-icon' && data && data.isCustom) {
            currentRightClickedAppId = data.id;
            ctxMenu.innerHTML += `<div class="ctx-item ctx-delete" onclick="deleteCustomApp()"><i class="fa-solid fa-trash"></i> Delete App</div>`;
            hasItems = true;
        }
        if (type === 'fs-window') {
            ctxMenu.innerHTML += `<div class="ctx-item ctx-import" onclick="triggerFileImport()"><i class="fa-solid fa-file-import"></i> Import File</div>`;
            hasItems = true;
        }
        if (hasItems) {
            ctxMenu.style.display = 'block'; ctxMenu.style.left = x + 'px'; ctxMenu.style.top = y + 'px';
        }
    }

    function triggerFileImport() { document.getElementById('file-uploader').click(); ctxMenu.style.display = 'none'; }

    function processFileImport(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                virtualFiles.push({ name: file.name, type: file.type, content: e.target.result, date: new Date().toLocaleDateString() });
                localStorage.setItem('edu_files', JSON.stringify(virtualFiles));
                if(openWindows['fs']) openWindows['fs'].querySelector('.window-body').innerHTML = generateFileGridHTML();
            } catch (err) { 
                alert("Large file imported. Please reopen the Files app to see it."); 
                
            }
        };
        reader.readAsDataURL(file);
        input.value = ''; 
    }

    function generateFileGridHTML() {
        if(virtualFiles.length === 0) return '<div class="file-grid" style="text-align:center;color:#666;display:flex;justify-content:center;align-items:center;">Right-click here to import files.</div>';
        let html = '<div class="file-grid">';
        virtualFiles.forEach((f, i) => {
            let icon = 'fa-file';
            if(f.type.startsWith('image/')) icon = 'fa-file-image';
            else if(f.type.startsWith('video/')) icon = 'fa-file-video';
            html += `<div class="file-item" onclick="openFileViewer(event, ${i})"><i class="fa-solid ${icon} file-icon"></i><div class="file-name">${f.name}</div></div>`;
        });
        html += '</div>';
        return html;
    }

    function openFileViewer(e, index) {
        e.stopPropagation();
        const file = virtualFiles[index];
        const winId = 'file-view-' + Date.now();
        let content = '';
        if (file.type.startsWith('video/')) {
            content = `<div style="display:flex;justify-content:center;align-items:center;height:100%;background:#000;"><video controls style="max-width:100%; max-height:100%; outline:none;" src="${file.content}"></video></div>`;
        } else if (file.type.startsWith('image/')) {
            content = `<div style="display:flex;justify-content:center;align-items:center;height:100%;background:#0f0f0f;"><img src="${file.content}" style="max-width:100%; max-height:100%; object-fit:contain;"></div>`;
        } else {
            content = `<iframe src="${file.content}" style="width:100%;height:100%;border:none;background:#fff;"></iframe>`;
        }
        createWindow(winId, file.name, content);
    }

    function deleteCustomApp() {
        if (!currentRightClickedAppId) return;
        apps = apps.filter(a => a.id !== currentRightClickedAppId);
        localStorage.setItem('customApps', JSON.stringify(apps.filter(a => a.isCustom)));
        renderIcons();
        ctxMenu.style.display = 'none';
    }

    // --- TERMINAL LOGIC ---
    function getTerminalHTML() {
        return `
        <div class="terminal-body" onclick="document.getElementById('term-input-field').focus()">
            <div id="term-output">
                <div>Welcome to EdulearnOS Terminal v2.0</div>
                <div style="margin-bottom:10px">Type 'help' for commands.</div>
            </div>
            <div class="term-input-line">
                <span class="term-prompt">user@edulearn:~$</span>
                <input type="text" id="term-input-field" class="term-input" autocomplete="off" onkeydown="handleTerminalCommand(event, this)">
            </div>
        </div>`;
    }

    function scrollToBottom() {
        const body = document.querySelector('.terminal-body');
        if(body) body.scrollTop = body.scrollHeight;
    }

    // IMPROVED NETWORK STATS (Real Speed Test)
    async function getNetworkStats() {
        let isp = 'Private/Unknown';
        try {
            const res = await fetch('https://ipapi.co/json/');
            const data = await res.json();
            if(data.org) isp = data.org;
        } catch(e) {}

        // Live Download Speed Test
        let speedMbps = "Checking...";
        try {
            const start = performance.now();
            // Fetch ~1.5MB image from Wikimedia (CORS friendly often) or similar
            // Using a generic cached image with a cache-buster
            const testUrl = "https://upload.wikimedia.org/wikipedia/commons/3/3a/Cat03.jpg?t=" + start;
            const sizeInBytes = 1600000; // Approx 1.6MB
            
            await fetch(testUrl, { mode: 'no-cors' }); 
            // Note: 'no-cors' opaque response makes precise timing hard on some networks, 
            // but for a rough "Fast.com" style check in a protected env:
            
            const end = performance.now();
            const durationSeconds = (end - start) / 1000;
            const bitsLoaded = sizeInBytes * 8;
            const mbps = (bitsLoaded / durationSeconds / 1000000).toFixed(2);
            speedMbps = mbps + " Mbps";
        } catch(e) {
            speedMbps = "Blocked/Err";
        }
        
        // Latency
        const startPing = Date.now();
        try { await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors', cache: 'no-cache' }); } catch(e) {} 
        const latency = Date.now() - startPing;

        return { speed: speedMbps, latency, isp };
    }

    async function handleTerminalCommand(e, input) {
        if (e.key === 'Enter') {
            const cmd = input.value.trim().toLowerCase();
            const output = document.getElementById('term-output');
            
            output.innerHTML += `<div class="term-line"><span class="term-prompt">user@edulearn:~$</span> ${input.value}</div>`;
            input.value = ''; 
            scrollToBottom();

            if (cmd === 'help') {
                output.innerHTML += `
                <div class="term-line" style="color:#aaa">
                  ping      - Check network latency
                  neofetch  - System information (Live Speed Test)
                  date      - Show current date/time
                  whoami    - Show current user
                  reboot    - Restart system
                  clear     - Clear terminal
                </div>`;
            } 
            else if (cmd === 'date') { output.innerHTML += `<div class="term-line">${new Date().toString()}</div>`; }
            else if (cmd === 'whoami') { output.innerHTML += `<div class="term-line">user</div>`; }
            else if (cmd === 'reboot') {
                output.innerHTML += `<div class="term-line" style="color:var(--term-red)">Rebooting system...</div>`;
                setTimeout(() => location.reload(), 1000);
            }
            else if (cmd === 'ping') {
                for(let i=0; i<4; i++) {
                    const start = Date.now();
                    try { await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors', cache: 'no-cache' }); } catch(e){}
                    const time = Date.now() - start;
                    output.innerHTML += `<div class="term-line">Reply from 8.8.8.8: bytes=32 time=${time}ms TTL=118</div>`;
                    scrollToBottom();
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
            else if (cmd === 'neofetch' || cmd === './neofetch.sh') {
                output.innerHTML += `<div class="term-line" style="color:gray">Running Speed Test (Wikimedia)... Please wait...</div>`;
                scrollToBottom();
                const stats = await getNetworkStats();
                const browser = navigator.userAgent.includes("Chrome") ? "Chrome" : "Firefox";
                output.lastElementChild.remove();
                const art = `
<div class="fetch-grid">
    <i class="fa-brands fa-linux os-logo-icon"></i>
    <div style="line-height:1.5; color: #fff;">
      <span style="color:var(--accent-color); font-weight:bold;">user@edulearn</span><br>
      -----------------<br>
      <strong>OS:</strong> EdulearnOS Ultimate<br>
      <strong>Uptime:</strong> ${Math.floor(performance.now()/60000)} mins<br>
      <strong>Resolution:</strong> ${window.innerWidth}x${window.innerHeight}<br>
      <strong>Browser:</strong> ${browser}<br>
      <span style="color:var(--term-green)"><strong>ISP:</strong> ${stats.isp}</span><br>
      <span style="color:var(--term-blue)"><strong>Speed:</strong> ${stats.speed}</span><br> 
      <span style="color:var(--term-red)"><strong>Ping:</strong> ${stats.latency}ms</span><br>
	  <span style="color:var(--term-yellow)"><strong>Note:</strong> Recheck speed if it looks off</span>
    </div>
</div>`;
                output.innerHTML += art;
            } 
            else if (cmd === 'clear') { output.innerHTML = ''; } 
            else if (cmd !== '') { output.innerHTML += `<div class="term-line">bash: ${cmd}: command not found</div>`; }
            scrollToBottom();
        }
    }

    // --- Window Logic ---
    function createWindow(id, title, innerHTML) {
        const win = document.createElement('div');
        win.className = 'window'; win.id = id;
        win.style.left = '100px'; win.style.top = '40px'; 
        win.style.height = 'calc(100vh - 140px)'; 
        win.style.zIndex = ++zIndexCounter;
        win.dataset.oldPos = JSON.stringify({l: '100px', t: '40px', w: '900px', h: 'calc(100vh - 140px)'});
        win.innerHTML = `
            <div class="window-header">
                <div class="win-controls">
                    <div class="control close" onclick="closeWin('${id}')"></div>
                    <div class="control min" onclick="toggleMin('${id}')"></div>
                    <div class="control max" onclick="toggleMax('${id}')"></div>
                </div>
                <span class="win-title">${title}</span>
                <div style="width:50px"></div>
            </div>
            <div class="window-body"><div class="drag-overlay"></div>${innerHTML}</div>
        `;
        document.body.appendChild(win);
        openWindows[id] = win;
        win.onmousedown = () => win.style.zIndex = ++zIndexCounter;
        win.querySelector('.window-header').onmousedown = (e) => startDragWin(e, win);
        return win;
    }

    function launch(app) {
        if (app.id === 'fs') {
            const win = createWindow(app.id, app.name, generateFileGridHTML());
            win.querySelector('.window-body').oncontextmenu = (e) => {
                if(e.target.closest('.file-item')) return;
                e.preventDefault();
                showContextMenu(e.clientX, e.clientY, 'fs-window');
            };
        } else if (app.id === 'term') {
            createWindow(app.id, app.name, getTerminalHTML());
            setTimeout(() => document.getElementById('term-input-field').focus(), 100);
        } else {
            const fullUrl = (app.url.includes('http') ? app.url : app.url + "?token=" + _0xKey);
            createWindow(app.id, app.name, `<iframe src="${fullUrl}"></iframe>`);
        }
    }

    function makeIconDraggable(elm, clickCallback) {
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;
        elm.onmousedown = function(e) {
            if (e.button === 2) return; 
            e.preventDefault(); isDragging = false;
            startX = e.clientX; startY = e.clientY; initialLeft = elm.offsetLeft; initialTop = elm.offsetTop;
            elm.style.zIndex = 50; 
            document.onmousemove = function(e) {
                const dx = e.clientX - startX; const dy = e.clientY - startY;
                if (Math.abs(dx) > 3 || Math.abs(dy) > 3) isDragging = true;
                if (isDragging) { elm.style.left = (initialLeft + dx) + "px"; elm.style.top = (initialTop + dy) + "px"; }
            };
            document.onmouseup = function() {
                document.onmousemove = null; document.onmouseup = null; elm.style.zIndex = ""; 
                if (!isDragging) clickCallback();
            };
        };
    }

    function startDragWin(e, win) {
        e.preventDefault(); 
        if(e.target.closest('.control')) return;
        const taskbar = document.getElementById('taskbar');
        if (win.classList.contains('maximized') || win.classList.contains('snap-left') || win.classList.contains('snap-right')) {
             const p = JSON.parse(win.dataset.oldPos);
             win.classList.remove('maximized', 'snap-left', 'snap-right');
             win.style.width = p.w; win.style.height = p.h;
             win.style.left = (e.clientX - 425) + "px"; win.style.top = (e.clientY - 20) + "px";
             taskbar.classList.remove('hidden');
        }
        const overlay = win.querySelector('.drag-overlay'); overlay.style.display = 'block';
        let startX = e.clientX; let startY = e.clientY; let winLeft = win.offsetLeft; let winTop = win.offsetTop;
        const snapBox = document.getElementById('snap-preview');
        function onMouseMove(e) {
            e.preventDefault();
            const dx = e.clientX - startX; const dy = e.clientY - startY; const newTop = winTop + dy;
            win.style.left = (winLeft + dx) + "px"; win.style.top = newTop + "px";
            if ((newTop + win.offsetHeight) > window.innerHeight - 20) taskbar.classList.add('hidden');
            else {
                const hasVisibleMax = Object.values(openWindows).some(w => w !== win && w.classList.contains('maximized') && !w.classList.contains('minimized'));
                if(!hasVisibleMax) taskbar.classList.remove('hidden');
            }
            if (e.clientY < 10) showSnap(0, 0, '100%', '100%');
            else if (e.clientX < 10) showSnap(0, 0, '50%', '100%');
            else if (e.clientX > window.innerWidth - 10) showSnap(0, '50%', '50%', '100%');
            else snapBox.style.display = 'none';
        }
        function showSnap(top, left, width, height) {
            snapBox.style.display = 'block'; snapBox.style.top = typeof top === 'number' ? top + 'px' : top;
            snapBox.style.left = typeof left === 'number' ? left + 'px' : left; snapBox.style.width = width; snapBox.style.height = height;
        }
        function onMouseUp(e) {
            document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp);
            overlay.style.display = 'none'; snapBox.style.display = 'none';
            if (e.clientY < 10) { win.classList.add('maximized'); taskbar.classList.add('hidden'); }
            else if (e.clientX < 10) { win.classList.add('snap-left'); taskbar.classList.add('hidden'); }
            else if (e.clientX > window.innerWidth - 10) { win.classList.add('snap-right'); taskbar.classList.add('hidden'); }
        }
        document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
    }

    function toggleMax(id) {
        const win = openWindows[id];
        const taskbar = document.getElementById('taskbar');
        win.classList.remove('snap-left', 'snap-right');
        if(!win.classList.contains('maximized')) {
            win.dataset.oldPos = JSON.stringify({l: win.style.left, t: win.style.top, w: win.style.width, h: win.style.height});
            win.classList.add('maximized'); taskbar.classList.add('hidden');
        } else {
            const p = JSON.parse(win.dataset.oldPos);
            win.style.left = p.l; win.style.top = p.t; win.style.width = p.w; win.style.height = p.h;
            win.classList.remove('maximized');
            const hasVisibleMax = Object.values(openWindows).some(w => w.classList.contains('maximized') && !w.classList.contains('minimized'));
            if(!hasVisibleMax) taskbar.classList.remove('hidden');
        }
    }

    function toggleMin(id) { 
        const win = openWindows[id];
        win.classList.toggle('minimized'); 
        if(!win.classList.contains('minimized')) {
            win.style.zIndex = ++zIndexCounter;
            if(win.classList.contains('maximized')) document.getElementById('taskbar').classList.add('hidden');
        } else {
            const hasVisibleMax = Object.values(openWindows).some(w => w.classList.contains('maximized') && !w.classList.contains('minimized'));
            if(!hasVisibleMax) document.getElementById('taskbar').classList.remove('hidden');
        }
    }

    function closeWin(id) { 
        const win = openWindows[id]; win.remove(); delete openWindows[id]; 
        const hasVisibleMax = Object.values(openWindows).some(w => w.classList.contains('maximized') && !w.classList.contains('minimized'));
        if(!hasVisibleMax) document.getElementById('taskbar').classList.remove('hidden');
    }

    const modal = document.getElementById('custom-app-modal');
    function openModal() { modal.style.display = 'flex'; }
    function closeModal() { modal.style.display = 'none'; document.getElementById('app-name-input').value = ''; document.getElementById('app-url-input').value = ''; }
    function saveCustomApp() {
        const name = document.getElementById('app-name-input').value; let url = document.getElementById('app-url-input').value;
        if (!name || !url) return alert("Please fill in all fields.");
        if (!url.startsWith('http') && !url.startsWith('/') && !url.startsWith('./')) url = 'https://' + url;
        apps.push({ id: 'custom-' + Date.now(), name: name, icon: 'fa-solid fa-link', url: url, isCustom: true });
        localStorage.setItem('customApps', JSON.stringify(apps.filter(a => a.isCustom)));
        renderIcons(); closeModal();
    }

    function openCloakMenu() {
        const m = prompt("Cloak: 1 (AB), 2 (Blob), 3 (Data)");
        const h = `<html><body style='margin:0;height:100vh'><iframe src='${window.location.href}' style='border:0;width:100%;height:100%'></iframe></body></html>`;
        if (m === "1") { const w = window.open("about:blank"); w.document.write(h); }
        else if (m === "2") window.open(URL.createObjectURL(new Blob([h], {type:"text/html"})));
        else if (m === "3") window.open("data:text/html;base64," + btoa(h));
    }
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }); }, 1000);
				</script>
</body>

</html>
