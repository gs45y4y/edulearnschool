<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Edulearn Lite</title>
	<link id="dynamic-favicon" rel="icon"
		href="https://cdn.classlink.com/production/launchpad/resources/images/favicon/favicon-32x32.png" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

	<style>
		/* --- DYNAMIC THEME ENGINE --- */
		:root {
			/* Defaults (Midnight Purple) - JS will overwrite these */
			--bg-deep: #020617;
			--bg-gradient-start: #4c1d95;
			--bg-gradient-mid: #1e1b4b;

			--accent-primary: #8b5cf6;
			--accent-glow: rgba(139, 92, 246, 0.5);

			--sidebar-bg: rgba(15, 23, 42, 0.7);
			--border-color: rgba(255, 255, 255, 0.08);

			--text-main: #ffffff;
			--text-muted: #94a3b8;

			--sidebar-width-collapsed: 90px;
			--sidebar-width-expanded: 240px;
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		body {
			font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background-color: var(--bg-deep);
			/* The signature Astro "Aurora" Gradient */
			background-image: radial-gradient(ellipse at 50% 0%, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 40%, var(--bg-deep) 80%);
			color: var(--text-main);
			overflow: hidden;
			display: flex;
			height: 100vh;
			font-size: 14px;
			line-height: 1.5;
			transition: background-image 0.5s ease, background-color 0.5s ease;
		}

		/* --- PARTICLES --- */
		#particles-js {
			position: absolute;
			width: 100%;
			height: 100%;
			top: 0;
			left: 0;
			z-index: 1;
			pointer-events: none;
			opacity: 0.6;
		}

		/* --- SIDEBAR --- */
		.sidebar {
			width: var(--sidebar-width-collapsed);
			height: 100vh;
			background: var(--sidebar-bg);
			border-right: 1px solid var(--border-color);
			backdrop-filter: blur(15px);
			-webkit-backdrop-filter: blur(15px);
			display: flex;
			flex-direction: column;
			transition: width 0.3s cubic-bezier(0.25, 1, 0.5, 1), background 0.5s ease;
			position: relative;
			z-index: 100;
			overflow: hidden;
		}

		.sidebar:hover {
			width: var(--sidebar-width-expanded);
		}

		/* LOGO SECTION */
		.brand {
			height: 80px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-bottom: 1px solid var(--border-color);
			margin-bottom: 10px;
			overflow: hidden;
			white-space: nowrap;
			transition: 0.3s;
		}

		.sidebar:hover .brand {
			justify-content: flex-start;
			padding-left: 20px;
		}

		/* Hexagon Animation */
		.hex-container {
			position: relative;
			width: 42px;
			height: 48px;
			display: flex;
			align-items: center;
			justify-content: center;
			margin-right: 0;
			transition: 0.3s;
			flex-shrink: 0;
		}

		.sidebar:hover .hex-container {
			margin-right: 15px;
		}

		.hex-shape {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(255, 255, 255, 0.05);
			border: 2px solid var(--accent-primary);
			clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
			box-shadow: 0 0 15px var(--accent-glow);
			animation: pulseHex 3s infinite ease-in-out;
			transition: border-color 0.5s, box-shadow 0.5s;
		}

		.hex-letter {
			z-index: 2;
			font-weight: 800;
			font-size: 20px;
			color: #fff;
			text-shadow: 0 0 10px var(--accent-primary);
		}

		@keyframes pulseHex {

			0%,
			100% {
				transform: scale(1);
				border-color: var(--accent-primary);
			}

			50% {
				transform: scale(1.05);
				border-color: #fff;
			}
		}

		.brand-text {
			opacity: 0;
			font-weight: 700;
			font-size: 16px;
			color: #fff;
			transition: opacity 0.2s;
			display: none;
		}

		.sidebar:hover .brand-text {
			display: block;
			opacity: 1;
			transition-delay: 0.1s;
		}


		/* NAV LINKS */
		.nav-links {
			display: flex;
			flex-direction: column;
			gap: 2px;
		}

		.nav-link {
			display: flex;
			align-items: center;
			height: 50px;
			color: var(--text-muted);
			text-decoration: none;
			cursor: pointer;
			transition: all 0.2s ease;
			font-weight: 500;
			white-space: nowrap;
			overflow: hidden;
			justify-content: center;
			padding: 0;
			border-right: 3px solid transparent;
		}

		.sidebar:hover .nav-link {
			justify-content: flex-start;
			padding: 0 25px;
		}

		.nav-link:hover {
			color: #fff;
			background: rgba(255, 255, 255, 0.03);
		}

		.nav-link.active {
			color: #fff;
			background: rgba(255, 255, 255, 0.05);
			border-right: 3px solid var(--accent-primary);
		}

		.nav-link i {
			font-size: 18px;
			width: 24px;
			text-align: center;
			transition: 0.2s;
		}

		.sidebar:hover .nav-link i {
			margin-right: 15px;
		}

		.nav-link span {
			display: none;
			opacity: 0;
		}

		.sidebar:hover .nav-link span {
			display: block;
			opacity: 1;
			animation: fadeText 0.3s forwards;
		}

		@keyframes fadeText {
			to {
				opacity: 1;
			}
		}

		/* FOOTER STATS */
		.sidebar-footer {
			margin-top: auto;
			border-top: 1px solid var(--border-color);
			background: rgba(0, 0, 0, 0.2);
			padding: 15px 0;
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.stat-row {
			display: flex;
			align-items: center;
			justify-content: center;
			height: 30px;
			color: var(--text-muted);
			font-size: 12px;
			overflow: hidden;
			white-space: nowrap;
			padding: 0 5px;
		}

		.sidebar:hover .stat-row {
			justify-content: flex-start;
			padding-left: 25px;
		}

		.stat-row i {
			width: 20px;
			text-align: center;
			font-size: 14px;
			margin-right: 5px;
		}

		.stat-value {
			color: #fff;
			font-weight: 600;
			font-family: monospace;
			display: inline-block;
		}

		.stat-label {
			display: none;
			margin-left: 8px;
			font-size: 12px;
		}

		.sidebar:hover .stat-label {
			display: inline;
			opacity: 1;
		}


		/* --- MAIN CONTENT --- */
		.main-content {
			flex: 1;
			position: relative;
			z-index: 10;
			display: flex;
			flex-direction: column;
		}

		.page {
			display: none;
			width: 100%;
			height: 100%;
			animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
		}

		.page.active {
			display: flex;
			flex-direction: column;
		}

		@keyframes fadeUp {
			from {
				opacity: 0;
				transform: translateY(10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* --- HERO SECTION --- */
		.home-container {
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			height: 100%;
			text-align: center;
			padding: 40px;
			max-width: 1000px;
			margin: 0 auto;
		}

		.version-pill {
			background: linear-gradient(90deg, var(--bg-gradient-start), var(--accent-primary));
			border: 1px solid rgba(255, 255, 255, 0.1);
			padding: 6px 16px;
			border-radius: 99px;
			font-size: 13px;
			font-weight: 600;
			margin-bottom: 30px;
			display: inline-flex;
			align-items: center;
			gap: 8px;
			box-shadow: 0 0 20px var(--accent-glow);
			cursor: default;
			transition: 0.5s;
		}

		.version-pill span {
			color: #fff;
		}

		#hero-title {
			font-size: 80px;
			font-weight: 800;
			letter-spacing: -2px;
			line-height: 1.1;
			margin-bottom: 20px;
			color: #fff;
			background: linear-gradient(180deg, #fff 0%, var(--accent-primary) 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			filter: drop-shadow(0 0 30px var(--accent-glow));
			transition: 0.5s;
		}

		.hero-subtitle {
			font-size: 24px;
			color: var(--text-muted);
			max-width: 600px;
			margin-bottom: 40px;
			font-weight: 400;
			line-height: 1.4;
		}

		.hero-actions {
			display: flex;
			gap: 20px;
			align-items: center;
		}

		.btn-astro-white {
			background: #fff;
			color: #000;
			font-size: 16px;
			font-weight: 600;
			padding: 14px 32px;
			border-radius: 999px;
			text-decoration: none;
			transition: transform 0.2s, box-shadow 0.2s;
			border: none;
			cursor: pointer;
		}

		.btn-astro-white:hover {
			transform: translateY(-2px);
			box-shadow: 0 0 25px rgba(255, 255, 255, 0.4);
		}

		.btn-astro-dark {
			background: rgba(255, 255, 255, 0.05);
			color: #fff;
			border: 1px solid rgba(255, 255, 255, 0.1);
			padding: 14px 24px;
			border-radius: 8px;
			font-family: monospace;
			font-size: 14px;
			display: flex;
			align-items: center;
			gap: 10px;
			cursor: pointer;
			transition: 0.2s;
		}

		.btn-astro-dark:hover {
			background: rgba(255, 255, 255, 0.1);
			border-color: rgba(255, 255, 255, 0.3);
		}

		.hero-footer-text {
			margin-top: 60px;
			color: rgba(255, 255, 255, 0.3);
			font-size: 13px;
			font-family: monospace;
			font-style: italic;
		}

		/* --- IFRAMES & UTILS --- */
		.iframe-wrapper {
			width: 100%;
			height: 100%;
			background: #000;
		}

		iframe {
			width: 100%;
			height: 100%;
			border: none;
		}

		/* --- MODALS --- */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.7);
			backdrop-filter: blur(8px);
			z-index: 2000;
			display: none;
			align-items: center;
			justify-content: center;
			opacity: 0;
			transition: opacity 0.3s;
		}

		.modal-overlay.active {
			display: flex;
			opacity: 1;
		}

		.settings-box {
			width: 800px;
			height: 550px;
			background: var(--bg-deep);
			border: 1px solid var(--border-color);
			border-radius: 12px;
			display: flex;
			overflow: hidden;
			box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
		}

		.settings-sidebar {
			width: 200px;
			background: rgba(0, 0, 0, 0.2);
			padding: 20px 0;
			border-right: 1px solid var(--border-color);
		}

		.set-tab {
			padding: 12px 24px;
			color: var(--text-muted);
			cursor: pointer;
			font-size: 14px;
			font-weight: 500;
			transition: 0.2s;
		}

		.set-tab:hover,
		.set-tab.active {
			color: #fff;
			background: rgba(255, 255, 255, 0.03);
		}

		.set-tab.active {
			border-left: 3px solid var(--accent-primary);
		}

		.settings-main {
			flex: 1;
			padding: 30px;
			overflow-y: auto;
		}

		.settings-group {
			display: none;
		}

		.settings-group.active {
			display: block;
			animation: fadeUp 0.3s;
		}

		.opt-card {
			background: rgba(255, 255, 255, 0.02);
			border: 1px solid var(--border-color);
			border-radius: 8px;
			padding: 20px;
			margin-bottom: 15px;
		}

		.opt-card h3 {
			color: #fff;
			margin-bottom: 5px;
			font-size: 16px;
		}

		.opt-card p {
			color: var(--text-muted);
			font-size: 13px;
			margin-bottom: 15px;
		}

		/* Inputs & Toggles */
		input[type="text"],
		input[type="url"],
		select {
			width: 100%;
			padding: 10px;
			background: rgba(0, 0, 0, 0.3);
			border: 1px solid var(--border-color);
			color: #fff;
			border-radius: 6px;
			outline: none;
			margin-top: 5px;
		}

		input:focus {
			border-color: var(--accent-primary);
		}

		/* Color Picker Styling */
		input[type="color"] {
			width: 100%;
			height: 40px;
			border: none;
			padding: 0;
			background: transparent;
			cursor: pointer;
		}

		.toggle-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-top: 10px;
		}

		.toggle-switch {
			position: relative;
			width: 44px;
			height: 24px;
		}

		.toggle-switch input {
			opacity: 0;
			width: 0;
			height: 0;
		}

		.slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #333;
			transition: .4s;
			border-radius: 34px;
		}

		.slider:before {
			position: absolute;
			content: "";
			height: 18px;
			width: 18px;
			left: 3px;
			bottom: 3px;
			background-color: white;
			transition: .4s;
			border-radius: 50%;
		}

		input:checked+.slider {
			background-color: var(--accent-primary);
		}

		input:checked+.slider:before {
			transform: translateX(20px);
		}

		.preset-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 10px;
		}

		.preset-btn {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 8px;
			padding: 15px;
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid var(--border-color);
			border-radius: 8px;
			cursor: pointer;
			color: var(--text-muted);
			transition: 0.2s;
		}

		.preset-btn:hover {
			border-color: var(--accent-primary);
			color: #fff;
		}

		.btn-small {
			padding: 8px 16px;
			background: var(--accent-primary);
			color: #fff;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 13px;
			margin-right: 5px;
		}

		.btn-danger {
			background: #7f1d1d;
			color: #fecaca;
		}
	</style>
</head>

<body>
	<canvas id="particles-js"></canvas>

	<nav class="sidebar">
		<div class="brand">
			<div class="hex-container">
				<div class="hex-shape"></div>
				<span class="hex-letter">E</span>
			</div>
			<span class="brand-text">Edulearn Lite</span>
		</div>

		<div class="nav-links">
			<a class="nav-link active" onclick="switchPage('home', this)">
				<i class="fa-solid fa-rocket"></i> <span>Start</span>
			</a>
			<a class="nav-link" onclick="switchPage('games-page', this)">
				<i class="fa-solid fa-gamepad"></i> <span>Games</span>
			</a>
			<a class="nav-link" onclick="switchPage('search-page', this)">
				<i class="fa-solid fa-globe"></i> <span>Browser</span>
			</a>
			<a class="nav-link" onclick="switchPage('tools-page', this)">
				<i class="fa-solid fa-wrench"></i> <span>Tools</span>
			</a>
			<a class="nav-link" onclick="openUpdates()">
				<i class="fa-solid fa-bolt"></i> <span>Updates</span>
			</a>
			<a class="nav-link" onclick="switchPage('info-page', this)">
				<i class="fa-solid fa-circle-info"></i> <span>Info</span>
			</a>
			<a class="nav-link" onclick="openSettings()">
				<i class="fa-solid fa-sliders"></i> <span>Config</span>
			</a>
			<a class="nav-link" onclick="switchPage('extras-page', this)">
				<i class="fa-solid fa-plus"></i> <span>Extras</span>
			</a>
		</div>

		<div class="sidebar-footer">
			<div class="stat-row">
				<i class="fa-regular fa-clock"></i>
				<span class="stat-value" id="session-time">00:00</span>
				<span class="stat-label">Session</span>
			</div>
			<div class="stat-row">
				<i id="fps-icon" class="fa-solid fa-gauge-high"></i>
				<span class="stat-value" id="fps-counter">60</span>
				<span class="stat-label">FPS</span>
			</div>
			<div class="stat-row">
				<i class="fa-solid fa-user-group" style="color:#4ade80;"></i>
				<span class="stat-value" id="online-count">0</span>
				<span class="stat-label">Online</span>
			</div>
			<div class="stat-row">
				<i id="bat-icon" class="fa-solid fa-battery-half"></i>
				<span class="stat-value" id="bat-level">--%</span>
				<span class="stat-label">Power</span>
			</div>
		</div>
	</nav>

	<main class="main-content">

		<section id="home" class="page active">
			<div class="home-container">

				<div class="version-pill">
					<span id="date-pill">Loading Date...</span>
					<i class="fa-solid fa-arrow-right" style="margin-left:5px; opacity:0.5;"></i>
				</div>

				<h1 id="hero-title">Edulearn Lite</h1>

				<p class="hero-subtitle">
					The cleanest unblocked experience. <br>
            Designed for speed, stealth, and performance.
          </p>

					<div class="hero-actions">
						<button class="btn-astro-white" onclick="startBrowsing()">
              Start Gaming
            </button>
						<button class="btn-astro-dark" onclick="openAboutBlank()">
              <i class="fa-solid fa-eye-slash"></i>
              <span>Launch about:blank</span>
            </button>
					</div>

					<div class="hero-footer-text" id="random-quote">
						"Loading quote..."
					</div>

			</div>
		</section>

		<section id="games-page" class="page">
			<div class="iframe-wrapper"><iframe src="./math/gn-math.html"></iframe></div>
		</section>
		<section id="search-page" class="page">
			<div class="iframe-wrapper"><iframe src="./active/index.html"></iframe></div>
		</section>
		<section id="tools-page" class="page">
			<div class="iframe-wrapper"><iframe src="./tools.html"></iframe></div>
		</section>
		<section id="info-page" class="page">
			<div class="iframe-wrapper"><iframe src="./info.html"></iframe></div>
		</section>
		<section id="extras-page" class="page">
			<div class="iframe-wrapper"><iframe src="./extras.html"></iframe></div>
		</section>

		<div class="modal-overlay" id="settings-modal">
			<div class="settings-box">
				<div class="settings-sidebar">
					<div class="set-tab active" onclick="setTab('s-gen', this)">General</div>
					<div class="set-tab" onclick="setTab('s-cloak', this)">Cloaking</div>
					<div class="set-tab" onclick="setTab('s-appear', this)">Appearance</div>
					<div class="set-tab" onclick="setTab('s-data', this)">Data</div>
					<div class="set-tab" onclick="setTab('s-exp', this)">Experiments</div>
					<div class="set-tab" style="color:#ef4444;" onclick="closeSettings()">Close</div>
				</div>
				<div class="settings-main">
					<div id="s-gen" class="settings-group active">
						<h2 style="margin-bottom:20px;">General Config</h2>
						<div class="opt-card">
							<h3>Panic Button</h3>
							<p>Quickly redirect to a safe page.</p>
							<input type="text" id="panic-key" placeholder="Click to bind key..." readonly onclick="bindPanic()">
							<input type="url" id="panic-url" value="https://google.com" placeholder="Redirect URL" onchange="savePanicSettings()">
							<div class="toggle-row">
								<span>Enable Panic Key</span>
								<label class="toggle-switch">
                    <input type="checkbox" id="panic-toggle" onchange="savePanicSettings()">
                    <span class="slider"></span>
                  </label>
							</div>
						</div>
					</div>

					<div id="s-cloak" class="settings-group">
						<h2 style="margin-bottom:20px;">Stealth</h2>
						<div class="opt-card">
							<h3>About:Blank Launcher</h3>
							<p>Open site in a cloaked about:blank window.</p>
							<button class="btn-small" onclick="openAboutBlank()">Launch About:Blank</button>
							<div class="toggle-row" style="margin-top:15px;">
								<span>Auto-launch on open</span>
								<label class="toggle-switch">
                     <input type="checkbox" id="auto-cloak-toggle" onchange="toggleAutoCloak(this)">
                     <span class="slider"></span>
                   </label>
							</div>
						</div>
						<div class="opt-card">
							<h3>Tab Disguise</h3>
							<p>Mask the browser tab icon and title.</p>
							<div class="preset-grid">
								<div class="preset-btn"
									onclick="setDisguise('Google Drive', 'https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png')">
									<i class="fa-brands fa-google-drive"></i> Drive
								</div>
								<div class="preset-btn"
									onclick="setDisguise('Classes', 'https://ssl.gstatic.com/classroom/favicon.png')">
									<i class="fa-solid fa-chalkboard-user"></i> Class
								</div>
								<div class="preset-btn"
									onclick="setDisguise('Gmail', 'https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico')">
									<i class="fa-solid fa-envelope"></i> Gmail
								</div>
							</div>
						</div>
					</div>

					<div id="s-appear" class="settings-group">
						<h2 style="margin-bottom:20px;">Appearance</h2>
						<div class="opt-card">
							<h3>Color Palette</h3>
							<p>Choose a preset or pick a custom color.</p>
							<select id="theme-select" onchange="changeTheme(this.value)">
                  <option value="midnight">Midnight (Purple)</option>
                  <option value="ocean">Ocean (Blue)</option>
                  <option value="sunset">Sunset (Orange)</option>
                  <option value="amoled">Amoled (Black)</option>
                  <option value="custom">Custom Color...</option>
                </select>
							<div id="custom-color-container" style="display:none; margin-top:10px;">
								<p style="margin-bottom:5px; font-size:12px;">Pick Accent Color:</p>
								<input type="color" id="custom-color-picker" onchange="applyCustomTheme(this.value)">
                </div>
							</div>
							<div class="opt-card">
								<h3>Effects</h3>
								<div class="toggle-row">
									<span>Background Particles</span>
									<label class="toggle-switch">
                    <input type="checkbox" id="particle-toggle" checked onchange="toggleParticles(this)">
                    <span class="slider"></span>
                  </label>
								</div>
							</div>
						</div>

						<div id="s-data" class="settings-group">
							<h2 style="margin-bottom:20px;">Data Management</h2>
							<div class="opt-card">
								<h3>Reset</h3>
								<p>Clear all saved settings and preferences.</p>
								<button class="btn-small btn-danger" onclick="localStorage.removeItem('el_settings'); location.reload();">Reset All Data</button>
							</div>
						</div>

						<div id="s-exp" class="settings-group">
							<h2 style="margin-bottom:20px;">Experiments</h2>
							<div class="opt-card">
								<h3>EdulearnOS</h3>
								<p>Switch to the experimental Desktop OS layout.</p>
								<div class="toggle-row">
									<span>Enable EdulearnOS</span>
									<label class="toggle-switch">
                      <input type="checkbox" id="edulearnos-toggle" onchange="toggleEdulearnOS(this)">
                      <span class="slider"></span>
                    </label>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>

			<div class="modal-overlay" id="updates-modal">
				<div class="settings-box" style="height:auto; padding:30px; width:500px; display:block;">
					<h2 style="color:#fff; margin-bottom:15px;">Latest Updates</h2>
					<ul style="color:#94a3b8; line-height:1.8; margin-bottom:20px;">
						<li>New UI: Replaced hacker theme with Astro style.</li>
						<li>Custom Themes: Pick any color you want!</li>
						<li>Dynamic Sidebar: Sidebar changes color with theme.</li>
						<li>Fixes: Restored all quotes and cloaking features.</li>
					</ul>
					<button class="btn-astro-white" style="width:100%; text-align:center;" onclick="document.getElementById('updates-modal').classList.remove('active')">Awesome</button>
				</div>
			</div>

	</main>

	<script>
		// --- DEFAULT SETTINGS ---
      const defaultSettings = {
          title: 'Edulearn Lite',
          icon: 'https://cdn.classlink.com/production/launchpad/resources/images/favicon/favicon-32x32.png',
          theme: 'midnight',
          customColor: '#8b5cf6', // Default violet if missing
          particles: true,
          autoCloak: false,
          panicKey: '`',
          panicUrl: 'https://google.com',
          panicEnabled: true
      };
      
      // MERGE OLD SETTINGS WITH DEFAULTS to prevent undefined errors
      let savedSettings = JSON.parse(localStorage.getItem('el_settings')) || {};
      let userSettings = { ...defaultSettings, ...savedSettings };
      
      // Fix for legacy users who might not have customColor
      if (!userSettings.customColor) userSettings.customColor = '#8b5cf6';

      // --- PARTICLES (STARS) ---
      const cvs = document.getElementById('particles-js');
      const ctx = cvs.getContext('2d');
      let parts = [];
      let particlesEnabled = userSettings.particles;

      function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
      window.onresize = resize; resize();

      class Star {
        constructor() { this.reset(); this.y = Math.random() * cvs.height; }
        reset() {
          this.x = Math.random() * cvs.width;
          this.y = -10;
          this.size = Math.random() * 2;
          this.speed = Math.random() * 0.5 + 0.1;
          this.opacity = Math.random() * 0.5 + 0.2;
        }
        update() {
          this.y += this.speed;
          if(this.y > cvs.height) this.reset();
        }
        draw() {
          ctx.fillStyle = `rgba(255,255,255,${this.opacity})`;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
          ctx.fill();
        }
      }

      function initParticles() {
        parts = [];
        for(let i=0; i<60; i++) parts.push(new Star());
        loop();
      }

      function loop() {
        if(!particlesEnabled) { ctx.clearRect(0,0,cvs.width, cvs.height); return; }
        ctx.clearRect(0,0,cvs.width, cvs.height);
        parts.forEach(p => { p.update(); p.draw(); });
        requestAnimationFrame(loop);
      }
      initParticles();
      
      function toggleParticles(cb) {
        userSettings.particles = cb ? cb.checked : particlesEnabled;
        particlesEnabled = userSettings.particles;
        saveSettings();
        if(particlesEnabled) loop();
      }

      // --- PAGE LOGIC ---
      function switchPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(el) {
          document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
          el.classList.add('active');
        }
      }

      function startBrowsing() {
        switchPage('games-page');
        document.querySelectorAll('.nav-link')[1].classList.add('active');
      }

      // --- DATE & SESSION TIME ---
      const startTime = Date.now();
      function tick() {
        const d = new Date();
        document.getElementById('date-pill').innerText = "Edulearn " + d.toLocaleDateString('en-US', { month:'short', day:'numeric' }) + " Available now!";
        
        // Session Time
        const diff = Math.floor((Date.now() - startTime) / 1000);
        const m = Math.floor(diff / 60);
        const s = diff % 60;
        document.getElementById('session-time').innerText = `${m}:${s.toString().padStart(2, '0')}`;
      }
      setInterval(tick, 1000); tick();

      // --- QUOTES ---
      const quotes = ["coded by the skids, for the skids", "teachers hate ts", "unblocked and unlocked", "running on pure caffeine", "if you're reading this, do your homework",
      "no admins allowed", "security through obscurity", "ctrl + w to win instantly", "made with <3 and spaghetti code", "Set this up in alt tab to quickly escape",
      "decode this: aHR0cHM6Ly9hbmRyZXdodWlzLmdheQ==", "last updated: Feb 3, 2026", "need more blahaj", "typing this while going to class lol",
      "How are you playing Hollow Knight at school bro?", "originally just a webview kajig", "frogiesarcade vibes", "This is where the fun begins - Obi Wan Kenobi",
      "vibecoded but it WORKS!", "Monkey find computer. Monkey type.", "goguardian is trash", "lightsped sytems", "go get the milk - therealfour, milk lover 67", 
      "No matter how much it feels like it, I'm not gay I swear! - A random", "Wait.. I can have MULTIPLE TABS?!? HOLY SHI*", "If you use this and I know you're a skid, screw you lmfao",
      "you're dumb", "I'm depressed typing this", "dont cry.. just.. cry", "gaming freedom!", "yall ready to play TS ALL DAY!?", "The ogs know of classroom.lol", 
      "tyrone's stupid games", "I have securly for breakfast, gogaurdian for lunch, and lightsped for dinner", "educational.sbs", "I'm jobless fr", "Jobless for using AI? Really?",
      "THIS SITE IS NOT FOR DEGENERATES. GO AWAY!!", "I should ring Alvin's gong - wise guy", "If you want to humiliate your enemies, do it in a way that doesn't waste your own time. Use AI - Sun Zu",
      "albie was here", "UNBLOCKED GAMES IN DA BIG 26!", "If you made it this far, join the discord!", "skids being skids", "your a skid buddy", "toggle off particles for better performance", "I'll steal your code hahaha - J20", "Hella sick while typing this", "bro wtf - guy", "last message so far.. consider yourself lucky.", "I use arch btw"];
      document.getElementById('random-quote').innerText = '"' + quotes[Math.floor(Math.random() * quotes.length)] + '"';

      // --- SETTINGS ---
      function openSettings() { document.getElementById('settings-modal').classList.add('active'); applySettingsInputs(); }
      function closeSettings() { document.getElementById('settings-modal').classList.remove('active'); }
      function openUpdates() { document.getElementById('updates-modal').classList.add('active'); }
      
      function setTab(id, el) {
        document.querySelectorAll('.settings-group').forEach(g => g.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.set-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
      }

      function applySettingsInputs() {
        document.getElementById('panic-key').value = userSettings.panicKey;
        document.getElementById('panic-url').value = userSettings.panicUrl;
        document.getElementById('panic-toggle').checked = userSettings.panicEnabled;
        document.getElementById('auto-cloak-toggle').checked = userSettings.autoCloak;
        
        const themeSelect = document.getElementById('theme-select');
        themeSelect.value = userSettings.theme;
        
        // Show/Hide custom picker
        document.getElementById('custom-color-container').style.display = (userSettings.theme === 'custom') ? 'block' : 'none';
        document.getElementById('custom-color-picker').value = userSettings.customColor;
        
        document.getElementById('particle-toggle').checked = userSettings.particles;
        document.getElementById('edulearnos-toggle').checked = false; 
      }

      function saveSettings() { localStorage.setItem('el_settings', JSON.stringify(userSettings)); }

      // --- THEME ENGINE ---
      function changeTheme(val) { 
        userSettings.theme = val; 
        document.getElementById('custom-color-container').style.display = (val === 'custom') ? 'block' : 'none';
        
        if (val === 'custom') {
            applyCustomTheme(userSettings.customColor);
        } else {
            applyThemePreset(val); 
        }
        saveSettings();
      }
      
      // Helper: Darken Hex Color (Safe)
      function adjustColor(color, amount) {
          if (!color) return '#000000'; // Safety fallback
          return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
      }
      
      // Helper: Hex to RGB
      function hexToRgb(hex) {
          if (!hex) return '0, 0, 0';
          let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '0, 0, 0';
      }

      function applyCustomTheme(hex) {
          if(!hex) hex = '#8b5cf6'; // Default if null
          userSettings.customColor = hex;
          saveSettings();
          
          const root = document.documentElement.style;
          // Set Main Accent
          root.setProperty('--accent-primary', hex);
          // Calculate Darker Backgrounds
          const dark1 = adjustColor(hex, -140); 
          const dark2 = adjustColor(hex, -180);
          
          root.setProperty('--bg-gradient-start', dark1);
          root.setProperty('--bg-gradient-mid', dark2);
          
          // Calculate Glows
          const rgb = hexToRgb(hex);
          root.setProperty('--accent-glow', `rgba(${rgb}, 0.5)`);
          
          // Calculate Sidebar Tint
          root.setProperty('--sidebar-bg', `rgba(${rgb}, 0.15)`); 
          
          // Ensure base is dark
          root.setProperty('--bg-deep', '#020617');
      }

      function applyThemePreset(themeName) {
        const root = document.documentElement.style;
        if (themeName === 'ocean') { 
            root.setProperty('--bg-deep', '#0f172a'); 
            root.setProperty('--bg-gradient-start', '#0369a1'); 
            root.setProperty('--bg-gradient-mid', '#0c4a6e'); 
            root.setProperty('--accent-primary', '#38bdf8'); 
            root.setProperty('--accent-glow', 'rgba(56, 189, 248, 0.5)'); 
            root.setProperty('--sidebar-bg', 'rgba(12, 74, 110, 0.5)');
        }
        else if (themeName === 'sunset') { 
            root.setProperty('--bg-deep', '#2a0a0a'); 
            root.setProperty('--bg-gradient-start', '#c2410c'); 
            root.setProperty('--bg-gradient-mid', '#451a03'); 
            root.setProperty('--accent-primary', '#f97316'); 
            root.setProperty('--accent-glow', 'rgba(249, 115, 22, 0.5)'); 
            root.setProperty('--sidebar-bg', 'rgba(67, 20, 7, 0.5)');
        }
        else if (themeName === 'amoled') { 
            root.setProperty('--bg-deep', '#000000'); 
            root.setProperty('--bg-gradient-start', '#111111'); 
            root.setProperty('--bg-gradient-mid', '#000000'); 
            root.setProperty('--accent-primary', '#ffffff'); 
            root.setProperty('--accent-glow', 'rgba(255, 255, 255, 0.2)'); 
            root.setProperty('--sidebar-bg', 'rgba(20, 20, 20, 0.8)');
        }
        else { 
            // Midnight (Default)
            root.setProperty('--bg-deep', '#020617'); 
            root.setProperty('--bg-gradient-start', '#4c1d95'); 
            root.setProperty('--bg-gradient-mid', '#1e1b4b'); 
            root.setProperty('--accent-primary', '#8b5cf6'); 
            root.setProperty('--accent-glow', 'rgba(139, 92, 246, 0.5)'); 
            root.setProperty('--sidebar-bg', 'rgba(15, 23, 42, 0.7)');
        }
      }

      // --- CLOAKING ---
      function setDisguise(title, icon) {
         userSettings.title = title; userSettings.icon = icon; saveSettings(); updateDisguise();
      }
      
      // *** UPDATED: IMMEDIATE DISGUISE FOR CURRENT TAB ***
      function updateDisguise() {
        document.title = userSettings.title;
        // Update favicon dynamically
        let link = document.getElementById("dynamic-favicon");
        if(!link) { 
            link = document.createElement('link'); 
            link.id = "dynamic-favicon";
            link.rel = 'icon'; 
            document.head.appendChild(link); 
        }
        link.href = userSettings.icon;
      }
      
      function toggleAutoCloak(cb) { userSettings.autoCloak = cb.checked; saveSettings(); }

      function openAboutBlank() {
        const win = window.open('about:blank', '_blank');
        if(!win) return alert("Popups Blocked! Allow popups to use this feature.");
        
        const iframe = win.document.createElement('iframe');
        iframe.style.width = "100%"; iframe.style.height = "100%"; iframe.style.border = "none";
        iframe.style.position = "fixed"; iframe.style.top = "0"; iframe.style.left = "0";
        iframe.src = window.location.href;
        
        win.document.body.appendChild(iframe);
        win.document.title = userSettings.title; 
        const link = win.document.createElement('link'); link.rel = "icon"; link.href = userSettings.icon;
        win.document.head.appendChild(link);
      }

      // --- PANIC ---
      function bindPanic() {
        const inp = document.getElementById('panic-key');
        inp.value = "[PRESS KEY]";
        document.addEventListener('keydown', function h(e) {
          userSettings.panicKey = e.key;
          inp.value = e.key;
          saveSettings();
          document.removeEventListener('keydown', h);
        });
      }
      function savePanicSettings() {
         userSettings.panicUrl = document.getElementById('panic-url').value;
         userSettings.panicEnabled = document.getElementById('panic-toggle').checked;
         saveSettings();
      }

      document.addEventListener('keydown', (e) => {
        if(userSettings.panicEnabled && e.key === userSettings.panicKey) {
            window.location.href = userSettings.panicUrl;
        }
      });

      // --- EXPERIMENTS ---
      function toggleEdulearnOS(cb) {
         if(cb.checked) window.location.href = "./x4konkor3.html";
      }

      // --- LIVE ONLINE USERS (VERCEL) ---
      const onlineId = crypto.randomUUID();

      async function updateOnline() {
        try {
          const r = await fetch(`/api/online?id=${onlineId}`, {
            cache: "no-store"
          });
          if (!r.ok) return;
          // The API must return PLAIN TEXT for this to work
          document.getElementById("online-count").textContent = await r.text();
        } catch {
          // fail silently
        }
      }

      updateOnline();
      setInterval(updateOnline, 15000);

      // --- INIT ---
      window.onload = () => {
          // 1. APPLY DISGUISE IMMEDIATELY TO CURRENT TAB
          updateDisguise();
          
          // 2. APPLY THEME
          if (userSettings.theme === 'custom') {
              applyCustomTheme(userSettings.customColor);
          } else {
              applyThemePreset(userSettings.theme);
          }
          
          // 3. AUTO-LAUNCH IF ENABLED
          if(userSettings.autoCloak && window.self === window.top) openAboutBlank();
      };

      // --- BATT & FPS ---
      function updateBatteryUI(battery) {
          const level = Math.round(battery.level * 100);
          const isCharging = battery.charging;
          const batVal = document.getElementById('bat-level');
          const batIcon = document.getElementById('bat-icon');
          
          batVal.innerText = level + '%';
          
          // Reset Icon Classes
          batIcon.className = "fa-solid";
          
          if (isCharging) {
              batIcon.classList.add("fa-bolt");
              batIcon.style.color = "#facc15"; // Yellow for charging
          } else {
              // Icon based on level
              if (level > 75) batIcon.classList.add("fa-battery-full");
              else if (level > 50) batIcon.classList.add("fa-battery-three-quarters");
              else if (level > 25) batIcon.classList.add("fa-battery-half");
              else batIcon.classList.add("fa-battery-quarter");
              
              // Color based on level
              if (level > 50) batIcon.style.color = "#4ade80"; // Green
              else if (level > 20) batIcon.style.color = "#facc15"; // Yellow
              else batIcon.style.color = "#ef4444"; // Red
          }
      }

      if(navigator.getBattery) {
        navigator.getBattery().then(b => {
          updateBatteryUI(b);
          b.onlevelchange = () => updateBatteryUI(b);
          b.onchargingchange = () => updateBatteryUI(b);
        });
      }
      
      let frames = 0;
      setInterval(() => {
          const fps = frames;
          const fpsEl = document.getElementById('fps-counter');
          const fpsIcon = document.getElementById('fps-icon');
          
          fpsEl.innerText = fps;
          
          // Color Logic
          if (fps >= 50) fpsIcon.style.color = "#4ade80"; // Green
          else if (fps >= 30) fpsIcon.style.color = "#facc15"; // Yellow
          else fpsIcon.style.color = "#ef4444"; // Red
          
          frames = 0;
      }, 1000);
      function loopFPS() { frames++; requestAnimationFrame(loopFPS); }
      loopFPS();

	</script>
</body>

</html>